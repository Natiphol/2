<!-- à¹‚à¸„à¹‰à¸” HTML à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸«à¸¡à¸·à¸­à¸™à¹€à¸”à¸´à¸¡ à¸¢à¸à¹€à¸§à¹‰à¸™ JS à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡ -->

<script>
const playGreetingBtn = document.getElementById('playGreetingBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const retryBtn = document.getElementById('retryBtn');
const playBtn = document.getElementById('playBtn');
const uploadBtn = document.getElementById('uploadBtn');
const nameInput = document.getElementById('nameInput');
const greetingText = document.getElementById('greetingText');
const groupSelect = document.getElementById('groupSelect');
const audioPlayback = document.getElementById('audioPlayback');
const canvas = document.getElementById('audioVisualizer');
const canvasCtx = canvas.getContext('2d');

let mediaRecorder, audioChunks = [], audioBlob, audioDataUrl;
let audioContext, analyser, sourceNode, animationId, recordTimeout;
const MAX_RECORD_TIME_MS = 240000;
const greetingAudio = new Audio('https://natiphol.github.io/33/Test.mp3');

function drawVisualizer() {
  if (!analyser) return;
  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;
  const bufferLength = analyser.fftSize;
  const dataArray = new Uint8Array(bufferLength);

  canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
  analyser.getByteTimeDomainData(dataArray);
  canvasCtx.lineWidth = 3;
  canvasCtx.strokeStyle = '#004080';
  canvasCtx.beginPath();
  const sliceWidth = WIDTH / bufferLength;
  let x = 0;
  for(let i = 0; i < bufferLength; i++) {
    const v = dataArray[i] / 128.0;
    const y = v * HEIGHT / 2;
    if(i === 0) canvasCtx.moveTo(x, y);
    else canvasCtx.lineTo(x, y);
    x += sliceWidth;
  }
  canvasCtx.lineTo(WIDTH, HEIGHT / 2);
  canvasCtx.stroke();
  animationId = requestAnimationFrame(drawVisualizer);
}

async function setupRecorder() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }); // fallback à¹ƒà¸Šà¹‰ webm à¸–à¹‰à¸² mp4 à¹„à¸¡à¹ˆà¹„à¸”à¹‰
    audioContext = new AudioContext();
    sourceNode = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    sourceNode.connect(analyser);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

      // à¸­à¹ˆà¸²à¸™ blob à¹€à¸›à¹‡à¸™ DataURL à¹à¸—à¸™ blob URL
      const reader = new FileReader();
      reader.onloadend = () => {
        audioDataUrl = reader.result;
        audioPlayback.src = audioDataUrl;
      };
      reader.readAsDataURL(audioBlob);

      try {
        await audioPlayback.play();
      } catch (err) {
        console.warn('Auto-play failed on iOS. Manual play required.');
      }

      playBtn.disabled = false;
      uploadBtn.disabled = false;
      retryBtn.disabled = false;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      cancelAnimationFrame(animationId);
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
      clearTimeout(recordTimeout);
    };
    return true;
  } catch (err) {
    alert('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸¡à¹‚à¸„à¸£à¹‚à¸Ÿà¸™à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸­à¸™à¸¸à¸à¸²à¸•à¸à¸²à¸£à¹ƒà¸Šà¹‰à¸‡à¸²à¸™');
    return false;
  }
}

playGreetingBtn.addEventListener('click', async () => {
  greetingText.textContent = 'ðŸŽ§ à¸à¸³à¸¥à¸±à¸‡à¹€à¸¥à¹ˆà¸™à¹€à¸ªà¸µà¸¢à¸‡à¸—à¸±à¸à¸—à¸²à¸¢...';
  playGreetingBtn.disabled = true;
  try {
    await greetingAudio.play();
  } catch (err) {
    console.warn('Greeting audio play failed:', err);
  }
  greetingAudio.onended = () => {
    startBtn.disabled = false;
    greetingText.textContent = 'âœ… à¸Ÿà¸±à¸‡à¸ˆà¸šà¹à¸¥à¹‰à¸§ à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡à¹„à¸”à¹‰';
  };
});

startBtn.addEventListener('click', async () => {
  if (!groupSelect.value) return alert('à¸à¸£à¸¸à¸“à¸²à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¸à¹ˆà¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“');
  if (!nameInput.value.trim()) return alert('à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­');
  if (!mediaRecorder) {
    const ready = await setupRecorder();
    if (!ready) return;
  }
  greetingText.textContent = 'ðŸŽ™ à¹€à¸£à¸´à¹ˆà¸¡à¸­à¸±à¸”à¹€à¸ªà¸µà¸¢à¸‡ à¸žà¸¹à¸”à¹„à¸”à¹‰à¹€à¸¥à¸¢';
  startBtn.disabled = true;
  audioChunks = [];
  mediaRecorder.start();
  stopBtn.disabled = false;
  retryBtn.disabled = true;
  playBtn.disabled = true;
  uploadBtn.disabled = true;
  drawVisualizer();
  recordTimeout = setTimeout(() => {
    if (mediaRecorder?.state === 'recording') {
      mediaRecorder.stop();
      greetingText.textContent = 'â° à¸«à¸¡à¸”à¹€à¸§à¸¥à¸² 4 à¸™à¸²à¸—à¸µ';
    }
  }, MAX_RECORD_TIME_MS);
});

stopBtn.addEventListener('click', () => {
  if (mediaRecorder?.state === 'recording') {
    mediaRecorder.stop();
    greetingText.textContent = 'ðŸ“ à¸«à¸¢à¸¸à¸”à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸ªà¸µà¸¢à¸‡à¹à¸¥à¹‰à¸§';
  }
});

retryBtn.addEventListener('click', () => {
  audioPlayback.pause();
  audioPlayback.removeAttribute('src');
  audioPlayback.load();
  playBtn.disabled = true;
  uploadBtn.disabled = true;
  retryBtn.disabled = true;
  greetingText.textContent = 'à¸ˆà¸°à¸®à¸² à¸ˆà¸°à¸‹à¸¶à¹‰à¸‡ à¸ˆà¸°à¸£à¹‰à¸­à¸‡à¹€à¸žà¸¥à¸‡à¸à¹‡à¹„à¸”à¹‰ à¸‚à¸­à¹à¸„à¹ˆà¸žà¸¹à¸”à¸–à¸¶à¸‡à¹€à¸ˆà¹‰à¸²à¸šà¹ˆà¸²à¸§à¹€à¸ˆà¹‰à¸²à¸ªà¸²à¸§à¸šà¹‰à¸²à¸‡à¸à¹‡à¸žà¸­ ðŸ˜„â¤ï¸';
});

playBtn.addEventListener('click', async () => {
  if (audioPlayback.src) {
    try {
      await audioPlayback.play();
    } catch (error) {
      console.log('Error playing audio:', error);
    }
  }
});

uploadBtn.addEventListener('click', async () => {
  if (!audioBlob || !nameInput.value.trim() || !groupSelect.value) return;
  const formData = new FormData();
  formData.append('audioBlob', audioBlob, 'voice.webm');
  formData.append('name', nameInput.value.trim());
  formData.append('group', groupSelect.value);
  uploadBtn.disabled = true;
  greetingText.textContent = 'â³ à¸à¸³à¸¥à¸±à¸‡à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”...';
  try {
    const response = await fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', {
      method: 'POST', body: formData
    });
    const text = await response.text();
    greetingText.textContent = text.includes('success')
      ? 'âœ… à¸‚à¸­à¸šà¸„à¸¸à¸“! à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸ªà¸µà¸¢à¸‡à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§'
      : 'âŒ à¸¡à¸µà¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”';
  } catch (err) {
    greetingText.textContent = 'âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: ' + err.message;
  }
});

function resizeCanvas() {
  canvas.width = canvas.clientWidth * window.devicePixelRatio;
  canvas.height = canvas.clientHeight * window.devicePixelRatio;
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('load', () => resizeCanvas());
</script>
