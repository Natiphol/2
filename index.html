<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á (‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á)</title>
<style>
  body {
    font-family: 'Kanit', sans-serif, sans-serif;
    max-width: 420px;
    margin: 2rem auto;
    padding: 1rem;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    text-align: center;
  }
  h1 {
    margin-bottom: 1rem;
  }
  input, select, button {
    font-size: 1rem;
    padding: 0.6rem;
    margin: 0.5rem 0;
    width: 100%;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    background-color: #0066cc;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background-color: #004999;
  }
  audio {
    margin-top: 1rem;
    width: 100%;
  }
  #status {
    margin-top: 1rem;
    min-height: 2rem;
    font-weight: 600;
    color: #333;
  }
  #timer {
    font-weight: bold;
    margin-top: 0.3rem;
    color: #d9534f;
  }
</style>
</head>
<body>

<h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</h1>

<input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πâ‡∏≤‡πÅ‡∏≠‡πä‡∏î)" />
<select id="group" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
  <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
</select>

<button id="startBtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
<button id="stopBtn" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
<button id="uploadBtn" disabled>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>

<div id="timer"></div>
<audio id="audioPlayer" controls></audio>
<div id="status"></div>

<script>
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const statusDiv = document.getElementById('status');
  const timerDiv = document.getElementById('timer');
  const nameInput = document.getElementById('name');
  const groupSelect = document.getElementById('group');

  let mediaRecorder;
  let audioChunks = [];
  let audioBlob;
  let stream;
  let recordingTimer;
  const maxRecordingTime = 180; // ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (3 ‡∏ô‡∏≤‡∏ó‡∏µ)
  let timeElapsed = 0;

  function resetUI() {
    startBtn.disabled = false;
    stopBtn.disabled = true;
    uploadBtn.disabled = true;
    timerDiv.textContent = "";
    statusDiv.textContent = "";
    audioPlayer.src = "";
    audioBlob = null;
    audioChunks = [];
    timeElapsed = 0;
    if (recordingTimer) {
      clearInterval(recordingTimer);
    }
  }

  function updateTimer() {
    timeElapsed++;
    const minutes = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
    const seconds = (timeElapsed % 60).toString().padStart(2, '0');
    timerDiv.textContent = `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${minutes}:${seconds}`;
    if (timeElapsed >= maxRecordingTime) {
      stopRecording();
    }
  }

  async function startRecording() {
    if (!nameInput.value.trim()) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
      return;
    }
    if (!groupSelect.value) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô");
      console.error(err);
      return;
    }

    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á blob ‡πÇ‡∏î‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î mime type ‡πÄ‡∏õ‡πá‡∏ô audio/webm
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      const audioUrl = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioUrl;
      audioPlayer.load();
      uploadBtn.disabled = false;
      statusDiv.textContent = "‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
    };

    mediaRecorder.start();
    statusDiv.textContent = "üéôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
    startBtn.disabled = true;
    stopBtn.disabled = false;
    uploadBtn.disabled = true;

    timeElapsed = 0;
    timerDiv.textContent = "‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: 00:00";
    recordingTimer = setInterval(updateTimer, 1000);
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
    stopBtn.disabled = true;
    startBtn.disabled = false;
    if (recordingTimer) clearInterval(recordingTimer);
    timerDiv.textContent = "";
  }

  async function uploadAudio() {
    if (!audioBlob) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
      return;
    }
    const name = nameInput.value.trim();
    const group = groupSelect.value;
    if (!name || !group) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
      return;
    }

    statusDiv.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
    uploadBtn.disabled = true;

    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64Audio = reader.result.split(',')[1];
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxE_TYcDqqheROL652jb8wHmg3K9IHujV6nwrXADVlYqX-RSJNfp1TfdyZdL4Zm7oODMw/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({
            name,
            group,
            audio: base64Audio
          })
        });
        const result = await response.json();
        if (result.success) {
          statusDiv.innerHTML = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br><a href="${result.url}" target="_blank" rel="noopener">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</a>`;
          uploadBtn.disabled = true;
          startBtn.disabled = false;
        } else {
          throw new Error(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        }
      } catch (err) {
        console.error(err);
        statusDiv.textContent = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
        uploadBtn.disabled = false;
      }
    };
    reader.readAsDataURL(audioBlob);
  }

  startBtn.onclick = startRecording;
  stopBtn.onclick = stopRecording;
  uploadBtn.onclick = uploadAudio;

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô UI
  resetUI();
</script>

</body>
</html>
