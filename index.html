<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Kanit', sans-serif;
      background-color: #fefefe;
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      padding: 1rem;
      box-sizing: border-box;
    }
    h1 {
      color: navy;
    }
    input, select, button {
      font-family: 'Kanit', sans-serif;
      font-size: 1rem;
      padding: 0.5rem;
      margin: 0.25rem 0;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
      -webkit-appearance: none;
    }
    button {
      background-color: #0055aa;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #visualizer {
      width: 100%;
      height: 30px;
      background: #eee;
      margin: 1rem 0;
      display: flex;
      gap: 2px;
    }
    .bar {
      flex: 1;
      background: #0077cc;
      transition: height 0.1s ease;
    }
  </style>
</head>
<body>
  <h1>üì£ ‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£</h1>

  <select id="group">
    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</option>
    <option value="groom-family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride-family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom-friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride-friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>

  <input type="text" id="name" placeholder="Your Name (A-Z only)" pattern="[A-Za-z0-9\s]+" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" />

  <button id="playGreetingBtn">‚ñ∂Ô∏è ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>

  <div id="visualizer"></div>

  <div id="buttonsContainer">
    <button id="startBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="stopBtn" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="resetBtn" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
  </div>

  <button id="uploadBtn" disabled style="margin-top: 1rem;">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>

  <script>
    const playGreetingBtn = document.getElementById('playGreetingBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const resetBtn = document.getElementById('resetBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const groupSelect = document.getElementById('group');
    const nameInput = document.getElementById('name');
    const visualizer = document.getElementById('visualizer');

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let greetingPlayed = false;
    let audioContext;
    let analyser;
    let dataArray;
    let animationId;

    const greetingAudio = new Audio('https://natiphol.github.io/33/Test.mp3'); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏£‡∏¥‡∏á

    playGreetingBtn.onclick = () => {
      greetingAudio.play();
      greetingAudio.onended = () => {
        greetingPlayed = true;
        startBtn.disabled = false;
      };
    };

    startBtn.onclick = async () => {
      const name = nameInput.value.trim();
      if (!/^[A-Za-z0-9\s]+$/.test(name)) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        uploadBtn.disabled = false;
        stopVisualizer();
      };

      mediaRecorder.start();
      startVisualizer(stream);

      startBtn.disabled = true;
      stopBtn.disabled = false;
      resetBtn.disabled = true;
      uploadBtn.disabled = true;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      startBtn.disabled = true;
      stopBtn.disabled = true;
      resetBtn.disabled = false;
    };

    resetBtn.onclick = () => {
      greetingAudio.pause();
      greetingAudio.currentTime = 0;
      audioChunks = [];
      uploadBtn.disabled = true;
      startBtn.disabled = !greetingPlayed;
      stopBtn.disabled = true;
      resetBtn.disabled = true;
    };

    uploadBtn.onclick = () => {
      const group = groupSelect.value;
      const name = nameInput.value.trim();

      if (!group || !name) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°");
        return;
      }

      if (!/^[A-Za-z0-9\s]+$/.test(name)) {
        alert("‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        return;
      }

      const filename = `${group}_${name}_${Date.now()}.webm`;
      const formData = new FormData();
      formData.append("audio", audioBlob, filename);

      fetch('https://script.google.com/macros/s/AKfycbxE_TYcDqqheROL652jb8wHmg3K9IHujV6nwrXADVlYqX-RSJNfp1TfdyZdL4Zm7oODMw/exec', {
        method: 'POST',
        body: formData
      }).then(() => {
        alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞!");
        resetBtn.click();
      }).catch(() => {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
      });
    };

    // Visualizer
    function startVisualizer(stream) {
      audioContext = new AudioContext();
      const source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      source.connect(analyser);
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      visualizer.innerHTML = '';
      for (let i = 0; i < 32; i++) {
        const bar = document.createElement('div');
        bar.className = 'bar';
        visualizer.appendChild(bar);
      }
      const bars = visualizer.querySelectorAll('.bar');

      const animate = () => {
        analyser.getByteFrequencyData(dataArray);
        bars.forEach((bar, i) => {
          const height = dataArray[i] / 2;
          bar.style.height = `${height}px`;
        });
        animationId = requestAnimationFrame(animate);
      };
      animate();
    }

    function stopVisualizer() {
      cancelAnimationFrame(animationId);
      if (audioContext) audioContext.close();
      visualizer.querySelectorAll('.bar').forEach(bar => {
        bar.style.height = '0px';
      });
    }
  </script>
</body>
</html>
