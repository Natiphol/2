<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
  body {
    font-family: 'Kanit', sans-serif;
    max-width: 620px;
    margin: 3rem auto 4rem;
    padding: 3rem 2.5rem 3rem;
    background: linear-gradient(135deg, #0b123d, #171c49);
    color: #f8f6f1;
    border-radius: 24px;
    box-shadow: 0 12px 32px rgba(255, 215, 0, 0.5);
    user-select: none;
    text-align: center;
  }
  h1 {
    font-weight: 900;
    font-size: 3.2rem;
    margin-bottom: 0.3rem;
    color: #ffd700;
    text-shadow: 0 0 12px #ffd700cc;
    letter-spacing: 0.1em;
  }
  select, input[type="text"] {
    width: 48%;
    padding: 1rem 1.3rem;
    font-size: 1.3rem;
    border-radius: 14px;
    border: 3px solid #ffd700;
    margin: 0.5rem 1% 1.5rem;
    background: #0d134d;
    color: #fffbea;
    outline-offset: 4px;
    box-shadow: 0 0 14px #ffd70044;
    transition: border-color 0.3s ease;
  }
  select:focus, input[type="text"]:focus {
    border-color: #ffef72;
    box-shadow: 0 0 18px #ffef72cc;
    background: #22295a;
  }
  .buttons {
    margin: 2.5rem 0 1.5rem;
  }
  button {
    background: linear-gradient(45deg, #ffd700, #ffb800);
    color: #1a1a3d;
    border: none;
    border-radius: 18px;
    padding: 1.1rem 2.8rem;
    font-size: 1.25rem;
    margin: 0 0.7rem 1rem;
    cursor: pointer;
    font-weight: 900;
    letter-spacing: 0.07em;
    box-shadow: 0 10px 26px rgba(255, 215, 0, 0.85);
    user-select: none;
    transition: all 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: linear-gradient(45deg, #ffed70, #ffc817);
    box-shadow: 0 14px 36px rgba(255, 215, 0, 1);
    transform: translateY(-2.5px);
  }
  button:disabled {
    background: #555566;
    color: #bbbccf;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }
  #progress-container {
    width: 100%;
    background: #282e5b;
    border-radius: 16px;
    overflow: hidden;
    margin: 1.5rem 0 2.5rem;
    height: 24px;
    box-shadow: inset 0 0 14px #1a1a3d;
    display: none;
  }
  #progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #ffd700, #ffb300);
    transition: width 0.25s ease;
  }
  #msg {
    margin-top: 1.8rem;
    font-weight: 800;
    font-size: 1.3rem;
    min-height: 1.6rem;
    color: #ffdb58;
    text-shadow: 0 0 14px #ffdb58bb;
    user-select: none;
  }
</style>
</head>
<body>
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>

  <select id="group" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)" aria-label="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" pattern="[A-Za-z\s]+" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" autocomplete="off" />

  <div class="buttons">
    <button id="start" disabled>‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î (‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô)</button>
    <button id="stop" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="upload" disabled>üì§ ‡∏™‡πà‡∏á</button>
  </div>

  <div id="progress-container"><div id="progress-bar"></div></div>

  <p id="msg"></p>

<script>
  const startBtn = document.getElementById("start");
  const stopBtn = document.getElementById("stop");
  const uploadBtn = document.getElementById("upload");
  const msg = document.getElementById("msg");
  const nameInput = document.getElementById("name");
  const groupSelect = document.getElementById("group");
  const progressContainer = document.getElementById("progress-container");
  const progressBar = document.getElementById("progress-bar");

  const greetingAudio = new Audio("https://natiphol.github.io/33/Test.mp3");

  let mediaRecorder;
  let recordedChunks = [];
  let audioBlob;

  const MAX_RECORD_TIME_MS = 180000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ

  // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL Google Apps Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxy-KeKpfN3asYpuRsozRgDn1WIA-oy2Dn7X1gRGKReqJBKKerUHLZrUyN7e3Ddg0C7/exec";

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö input
  function checkInputs() {
    const nameVal = nameInput.value.trim();
    const groupVal = groupSelect.value;
    const nameValid = /^[A-Za-z\s]+$/.test(nameVal);
    startBtn.disabled = !(nameValid && groupVal);
    uploadBtn.disabled = true;
    stopBtn.disabled = true;
    msg.textContent = "";
  }
  nameInput.addEventListener("input", checkInputs);
  groupSelect.addEventListener("change", checkInputs);

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏î
  startBtn.addEventListener("click", () => {
    startBtn.disabled = true;
    msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...";
    greetingAudio.play();
    greetingAudio.onended = () => {
      startRecording();
    };
  });

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  async function startRecording() {
    recordedChunks = [];
    msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ô‡∏≤‡∏ó‡∏µ)";
    stopBtn.disabled = false;

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        audioBlob = new Blob(recordedChunks, { type: "audio/webm" });
        msg.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
        uploadBtn.disabled = false;
        stopBtn.disabled = true;
      };

      mediaRecorder.start();

      setTimeout(() => {
        if (mediaRecorder.state === "recording") mediaRecorder.stop();
      }, MAX_RECORD_TIME_MS);
    } catch (err) {
      msg.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ";
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  stopBtn.addEventListener("click", () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
  });

  // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ Google Drive ‡∏ú‡πà‡∏≤‡∏ô Google Apps Script
  uploadBtn.addEventListener("click", async () => {
    if (!audioBlob) {
      alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
      return;
    }

    const nameRaw = nameInput.value.trim();
    const groupVal = groupSelect.value;
    if (!nameRaw || !groupVal) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÑ‡∏°‡πà‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ ‡πÉ‡∏ä‡πâ _ ‡πÅ‡∏ó‡∏ô
    const safeName = nameRaw.replace(/\s+/g, "_");
    const filename = `${groupVal}_${safeName}.webm`;

    progressContainer.style.display = "block";
    progressBar.style.width = "0%";
    msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå...";

    // 1) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥
    try {
      let checkForm = new FormData();
      checkForm.append("action", "check");
      checkForm.append("name", filename);

      let response = await fetch(UPLOAD_URL, {
        method: "POST",
        body: checkForm
      });

      let result = await response.json();

      if (result.exists) {
        if (!confirm("‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
          msg.textContent = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
          progressContainer.style.display = "none";
          return;
        }
      }
    } catch (e) {
      msg.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ";
      progressContainer.style.display = "none";
      return;
    }

    // 2) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á
    const uploadForm = new FormData();
    uploadForm.append("action", "upload");
    uploadForm.append("name", filename);
    uploadForm.append("file", audioBlob);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", UPLOAD_URL, true);

    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        let percent = (e.loaded / e.total) * 100;
        progressBar.style.width = percent + "%";
      }
    };

    xhr.onload = () => {
      if (xhr.status === 200) {
        msg.textContent = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞!";
      } else {
        msg.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
      }
      progressContainer.style.display = "none";
      progressBar.style.width = "0%";
      startBtn.disabled = false;
      uploadBtn.disabled = true;
    };

    xhr.onerror = () => {
      msg.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
      progressContainer.style.display = "none";
      progressBar.style.width = "0%";
      startBtn.disabled = false;
      uploadBtn.disabled = true;
    };

    xhr.send(uploadForm);
  });
</script>
</body>
</html>
