<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      background: linear-gradient(to bottom, #fff8f0, #f5f5fa);
      color: #2c2c54;
      text-align: center;
      padding: 2rem;
    }
    h1 {
      font-size: 2.2rem;
      color: #b89d5b;
      margin-bottom: 1rem;
    }
    input, select, button {
      font-family: 'Kanit', sans-serif;
      font-size: 1rem;
      padding: 0.6rem 1rem;
      margin: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #1f2a44;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    audio {
      margin: 1rem auto;
    }
    canvas {
      display: block;
      margin: 1rem auto;
      background: #fff;
      border-radius: 10px;
    }
    #status {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</h1>
  <audio id="greeting" src="https://raw.githubusercontent.com/yourusername/yourrepo/main/Test.mp3" controls></audio>

  <div>
    <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πâ‡∏≤‡πÅ‡∏≠‡πä‡∏î)" />
    <select id="group">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
      <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
      <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    </select>
  </div>

  <canvas id="visualizer" width="300" height="80"></canvas>

  <div>
    <button id="recordBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="stopBtn" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="uploadBtn" disabled>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
  </div>

  <audio id="audioPlayer" controls></audio>
  <div id="status"></div>

  <script>
    const greeting = document.getElementById('greeting');
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const audioPlayer = document.getElementById('audioPlayer');
    const statusDiv = document.getElementById('status');
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let audioUrl;
    let audioStream;
    let animationId;

    greeting.addEventListener('ended', () => {
      recordBtn.disabled = false;
    });

    function visualize(stream) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();
      source.connect(analyser);
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);

        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const barHeight = dataArray[i] / 2;
          ctx.fillStyle = '#b89d5b';
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }
      }

      draw();
    }

    recordBtn.onclick = async () => {
      audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(audioStream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/m4a' });
        audioUrl = URL.createObjectURL(audioBlob);
        audioPlayer.src = audioUrl;
        uploadBtn.disabled = false;
        cancelAnimationFrame(animationId);
        audioStream.getTracks().forEach(t => t.stop());
      };

      mediaRecorder.start();
      visualize(audioStream);
      setTimeout(() => {
        if (mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          stopBtn.disabled = true;
          recordBtn.disabled = false;
          statusDiv.innerText = "‚è±Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏ö 3 ‡∏ô‡∏≤‡∏ó‡∏µ";
        }
      }, 3 * 60 * 1000); // 3 ‡∏ô‡∏≤‡∏ó‡∏µ

      statusDiv.innerText = "üéôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
      recordBtn.disabled = true;
      stopBtn.disabled = false;
      uploadBtn.disabled = true;
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recordBtn.disabled = false;
      stopBtn.disabled = true;
      statusDiv.innerText = "‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß";
    };

    uploadBtn.onclick = async () => {
      const name = document.getElementById('name').value.trim();
      const group = document.getElementById('group').value;
      if (!name || !group) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        return;
      }

      statusDiv.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
      uploadBtn.disabled = true;

      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Audio = reader.result.split(',')[1];
        try {
          const response = await fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ name, group, audio: base64Audio })
          });

          const result = await response.json();
          if (result.success) {
            statusDiv.innerHTML = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br><a href="${result.url}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</a>`;
          } else {
            throw new Error(result.message);
          }
        } catch (err) {
          console.error(err);
          statusDiv.innerText = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
        }
      };
      reader.readAsDataURL(audioBlob);
    };
  </script>
</body>
