<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
      text-align: center;
      background: #f0f8ff;
      color: #333;
    }
    button, select, input {
      margin: 0.5rem 0.3rem;
      padding: 0.8rem 1rem;
      font-size: 1.1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      outline: none;
      cursor: pointer;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #visualizer {
      width: 100%;
      height: 80px;
      border: 1px solid #0099ff;
      border-radius: 6px;
      margin: 1rem 0;
      background: #e0f7ff;
    }
    audio {
      width: 100%;
      margin-top: 1rem;
      outline: none;
    }
    #msg {
      margin-top: 1rem;
      font-weight: 600;
      color: #007acc;
      min-height: 1.2rem;
    }
  </style>
</head>
<body>
  <h1>üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</h1>

  <select id="group">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />

  <div>
    <button id="start" disabled>‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î (‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô)</button>
    <button id="stop" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="play" disabled>üîä ‡∏ü‡∏±‡∏á</button>
    <button id="retry" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="upload" disabled>üì§ ‡∏™‡πà‡∏á</button>
  </div>

  <canvas id="visualizer"></canvas>

  <audio id="audio" controls style="display:none;"></audio>
  <audio id="greetingAudio" src="https://natiphol.github.io/33/Test.mp3"></audio>

  <p id="msg"></p>

  <script>
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const playBtn = document.getElementById("play");
    const retryBtn = document.getElementById("retry");
    const uploadBtn = document.getElementById("upload");
    const audioPlayback = document.getElementById("audio");
    const greetingAudio = document.getElementById("greetingAudio");
    const msg = document.getElementById("msg");
    const nameInput = document.getElementById("name");
    const groupSelect = document.getElementById("group");
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");

    let mediaRecorder;
    let recordedChunks = [];
    let audioBlob;
    let animationId;
    let audioContext, analyser, source;
    let stream;

    const MAX_RECORD_TIME_MS = 180000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ
    let recordTimeout;

    function resetUI() {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      playBtn.disabled = !audioBlob;
      retryBtn.disabled = !audioBlob;
      uploadBtn.disabled = !audioBlob;
      audioPlayback.style.display = audioBlob ? "block" : "none";
      msg.textContent = "";
      clearTimeout(recordTimeout);
      cancelAnimationFrame(animationId);
      clearCanvas();
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#e0f7ff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawVisualizer() {
      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);

        ctx.fillStyle = "#e0f7ff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.lineWidth = 2;
        ctx.strokeStyle = "#007acc";

        ctx.beginPath();

        const sliceWidth = canvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const v = dataArray[i] / 128.0;
          const y = (v * canvas.height) / 2;

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
          x += sliceWidth;
        }

        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
      }
      draw();
    }

    async function initStream() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        source.connect(analyser);

        // Set canvas size dynamically
        canvas.width = canvas.clientWidth;
        canvas.height = 80;

        return true;
      } catch (e) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï");
        return false;
      }
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö MIME type ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
    function getSupportedMimeType() {
      if (MediaRecorder.isTypeSupported("audio/mp4")) return "audio/mp4";
      if (MediaRecorder.isTypeSupported("audio/m4a")) return "audio/m4a";
      if (MediaRecorder.isTypeSupported("audio/webm")) return "audio/webm";
      if (MediaRecorder.isTypeSupported("audio/ogg")) return "audio/ogg";
      return "";
    }

    async function startRecording() {
      if (!nameInput.value.trim()) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
        return false;
      }
      if (!groupSelect.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°");
        return false;
      }

      if (!stream) {
        const ready = await initStream();
        if (!ready) return false;
      }

      recordedChunks = [];
      const mimeType = getSupportedMimeType();

      if (!mimeType) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
        return false;
      }

      mediaRecorder = new MediaRecorder(stream, { mimeType });
      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(recordedChunks, { type: mimeType });
        const url = URL.createObjectURL(audioBlob);
        audioPlayback.src = url;
        audioPlayback.style.display = "block";
        resetUI();
      };

      // Play greeting first
      msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...";
      await new Promise((res) => {
        greetingAudio.play();
        greetingAudio.onended = res;
      });

      mediaRecorder.start();
      msg.textContent = "üéô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
      drawVisualizer();

      startBtn.disabled = true;
      stopBtn.disabled = false;
      playBtn.disabled = true;
      retryBtn.disabled = true;
      uploadBtn.disabled = true;

      // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      recordTimeout = setTimeout(() => {
        stopRecording();
        msg.textContent = "‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ô‡∏≤‡∏ó‡∏µ";
      }, MAX_RECORD_TIME_MS);

      return true;
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      stopBtn.disabled = true;
      startBtn.disabled = false;
      clearTimeout(recordTimeout);
      cancelAnimationFrame(animationId);
      msg.textContent = "üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
    }

    startBtn.onclick = () => startRecording();

    stopBtn.onclick = () => stopRecording();

    playBtn.onclick = () => {
      if (audioPlayback.src) {
        audioPlayback.play();
      }
    };

    retryBtn.onclick = () => {
      audioBlob = null;
      audioPlayback.src = "";
      audioPlayback.style.display = "none";
      resetUI();
      msg.textContent = "üé§ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà";
    };

    uploadBtn.onclick = async () => {
      if (!audioBlob) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
        return;
      }
      const filename = `${nameInput.value.trim().replace(/\s+/g, '_')}_${groupSelect.value}.m4a`;
      const formData = new FormData();
      formData.append("audio", audioBlob, filename);
      formData.append("name", nameInput.value.trim());
      formData.append("group", groupSelect.value);

      uploadBtn.disabled = true;
      uploadBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

      try {
        // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const response = await fetch("/upload", { method: "POST", body: formData });
        const result = await response.json();
        if (result.success) {
          msg.textContent = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö!";
        } else {
          throw new Error(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        }
      } catch (err) {
        alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        msg.textContent = "";
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "üì§ ‡∏™‡πà‡∏á";
      }
    };

    // Enable start button ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß
    function checkInput() {
      startBtn.disabled = !(nameInput.value.trim() && groupSelect.value);
    }

    nameInput.addEventListener("input", checkInput);
    groupSelect.addEventListener("change", checkInput);

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô UI
    resetUI();
  </script>
</body>
</html>
