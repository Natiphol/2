<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
<style>
  /* ...css ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°... */
</style>
</head>
<body>
  <div class="container">
    <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>

    <label for="groupSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
    <select id="groupSelect">
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
      <option value="groom_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
      <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    </select>

    <label for="nameInput">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
    <input type="text" id="nameInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />

    <button id="playGreetingBtn">üì¢ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>
    <button id="startBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="stopBtn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="retryBtn" disabled>üîÑ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="playBtn" disabled>‚ñ∂ ‡∏ü‡∏±‡∏á</button>
    <button id="uploadBtn" disabled>üì§ ‡πÅ‡∏ä‡∏£‡πå / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>

    <canvas id="audioVisualizer"></canvas>

    <audio id="audioPlayback" controls></audio>

    <p id="statusMessage" style="margin-top:15px; font-weight:600; color:#004080;"></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/recorder-js@1.0.3/dist/recorder.min.js"></script>

  <script>
    const playGreetingBtn = document.getElementById('playGreetingBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const retryBtn = document.getElementById('retryBtn');
    const playBtn = document.getElementById('playBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const groupSelect = document.getElementById('groupSelect');
    const nameInput = document.getElementById('nameInput');
    const audioPlayback = document.getElementById('audioPlayback');
    const canvas = document.getElementById('audioVisualizer');
    const statusMessage = document.getElementById('statusMessage');
    const ctx = canvas.getContext('2d');

    const MAX_RECORD_TIME_MS = 180000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ
    const greetingAudio = new Audio('https://natiphol.github.io/33/Test.mp3');

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let audioUrl;
    let audioContext;
    let analyser;
    let sourceNode;
    let animationId;
    let recordTimeout;
    let recorder; // Recorder.js fallback instance
    let stream;

    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    function resetUI() {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      retryBtn.disabled = true;
      playBtn.disabled = true;
      uploadBtn.disabled = true;
      statusMessage.textContent = '';
      audioPlayback.pause();
      audioPlayback.src = '';
      audioChunks = [];
      audioBlob = null;
      audioUrl = null;
      cancelAnimationFrame(animationId);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      clearTimeout(recordTimeout);
    }

    function drawVisualizer() {
      if (!analyser) return;
      const WIDTH = canvas.width;
      const HEIGHT = canvas.height;
      const bufferLength = analyser.fftSize;
      const dataArray = new Uint8Array(bufferLength);

      analyser.getByteTimeDomainData(dataArray);

      ctx.fillStyle = '#cce7ff';
      ctx.fillRect(0, 0, WIDTH, HEIGHT);

      ctx.lineWidth = 3;
      ctx.strokeStyle = '#004080';
      ctx.beginPath();

      const sliceWidth = WIDTH / bufferLength;
      let x = 0;
      for(let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * HEIGHT / 2;
        if(i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }
      ctx.lineTo(WIDTH, HEIGHT / 2);
      ctx.stroke();

      animationId = requestAnimationFrame(drawVisualizer);
    }

    async function setupStream() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô');
          return false;
        }
        if (stream) {
          // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ stream ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
        if (audioContext) {
          await audioContext.close();
          audioContext = null;
        }
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new AudioContext();
        sourceNode = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        sourceNode.connect(analyser);

        if (isIOS()) {
          recorder = new Recorder(sourceNode, { numChannels: 1 });
        } else {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = onRecordingStop;
        }
        console.log('Microphone stream and recorder ready.');
        return true;
      } catch (err) {
        console.error('Error accessing microphone:', err);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ: ' + err.message);
        return false;
      }
    }

    function onRecordingStop() {
      if (isIOS()) {
        recorder && recorder.exportWAV(blob => {
          audioBlob = blob;
          setupPlayback();
        });
      } else {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        setupPlayback();
      }
    }

    function setupPlayback() {
      if (audioUrl) URL.revokeObjectURL(audioUrl);
      audioUrl = URL.createObjectURL(audioBlob);
      audioPlayback.src = audioUrl;
      playBtn.disabled = false;
      uploadBtn.disabled = false;
      retryBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      statusMessage.textContent = '‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
      cancelAnimationFrame(animationId);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      clearTimeout(recordTimeout);
    }

    playGreetingBtn.addEventListener('click', () => {
      playGreetingBtn.disabled = true;
      statusMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...';
      greetingAudio.play();
      greetingAudio.onended = () => {
        statusMessage.textContent = '‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ';
        playGreetingBtn.disabled = false;
        startBtn.disabled = false;
      };
    });

    startBtn.addEventListener('click', async () => {
      if (!groupSelect.value) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
        return;
      }
      if (!nameInput.value.trim()) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©');
        return;
      }
      if (!mediaRecorder && !recorder) {
        const ready = await setupStream();
        if (!ready) return;
      }
      statusMessage.textContent = 'üéô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...';
      startBtn.disabled = true;
      stopBtn.disabled = false;
      retryBtn.disabled = true;
      playBtn.disabled = true;
      uploadBtn.disabled = true;
      audioChunks = [];

      if (isIOS()) {
        recorder && recorder.start();
      } else {
        mediaRecorder.start();
      }
      drawVisualizer();

      recordTimeout = setTimeout(() => {
        stopBtn.click();
      }, MAX_RECORD_TIME_MS);
    });

    stopBtn.addEventListener('click', () => {
      statusMessage.textContent = '‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß';
      stopBtn.disabled = true;
      if (isIOS()) {
        recorder && recorder.stop();
      } else {
        mediaRecorder.stop();
      }
      clearTimeout(recordTimeout);
    });

    retryBtn.addEventListener('click', () => {
      resetUI();
      statusMessage.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà';
    });

    playBtn.addEventListener('click', () => {
      if (!audioUrl) return;
      audioPlayback.play();
    });

    uploadBtn.addEventListener('click', () => {
      if (!audioBlob) {
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á');
        return;
      }
      if (!groupSelect.value || !nameInput.value.trim()) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        return;
      }

      const filename = `${groupSelect.value}_${nameInput.value.trim().replace(/[^a-zA-Z0-9_-]/g,'_')}_${Date.now()}.webm`;

      statusMessage.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå: ${filename}`;

      // TODO: ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô Google Drive API ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
      setTimeout(() => {
        statusMessage.textContent = `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞ üòä`;
        uploadBtn.disabled = true;
        retryBtn.disabled = false;
      }, 2500);
    });

    // ‡∏õ‡∏¥‡∏î startBtn ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
    startBtn.disabled = true;

  </script>
</body>
</html>
