<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Kanit', sans-serif;
      max-width: 420px;
      margin: 2rem auto;
      padding: 1rem;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      text-align: center;
    }
    img.logo {
      width: 100px;
      margin: 1rem auto;
      display: block;
      border-radius: 12px;
    }
    h1 {
      margin-bottom: 1rem;
    }
    input, select, button {
      font-size: 1rem;
      padding: 0.6rem;
      margin: 0.5rem 0;
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #004999;
    }
    audio {
      margin-top: 1rem;
      width: 100%;
    }
    canvas {
      width: 100%;
      height: 100px;
      margin-top: 1rem;
      display: none;
    }
    #status {
      margin-top: 1rem;
      font-weight: 600;
      min-height: 2rem;
      color: #333;
    }
    .rose-spinner {
      width: 50px;
      height: 50px;
      margin: 1rem auto;
      background-image: url('https://i.imgur.com/0Oa5Z5l.png');
      background-size: cover;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<img src="https://i.imgur.com/n0DtfkQ.jpg" alt="logo" class="logo" />
<h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</h1>

<input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πâ‡∏≤‡πÅ‡∏≠‡πä‡∏î)" />
<select id="group">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
  <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
</select>

<button id="greetingBtn">‚ñ∂Ô∏è ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>
<button id="startBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
<button id="resetBtn" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
<button id="uploadBtn" disabled>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>

<canvas id="visualizer"></canvas>
<audio id="audioPlayer" controls></audio>

<div class="rose-spinner" id="roseSpinner"></div>
<div id="status"></div>

<script>
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const greetingBtn = document.getElementById('greetingBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const statusDiv = document.getElementById('status');
  const nameInput = document.getElementById('name');
  const groupSelect = document.getElementById('group');
  const visualizerCanvas = document.getElementById('visualizer');
  const roseSpinner = document.getElementById('roseSpinner');

  let mediaRecorder, stream, audioChunks = [], audioBlob;
  let audioCtx, analyser, dataArray, source, animationId;
  let greetingPlayed = false;

  function showVisualizer(stream) {
    visualizerCanvas.style.display = 'block';
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    analyser.fftSize = 2048;
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    const ctx = visualizerCanvas.getContext('2d');

    function draw() {
      animationId = requestAnimationFrame(draw);
      analyser.getByteTimeDomainData(dataArray);
      ctx.fillStyle = '#f9f9f9';
      ctx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
      ctx.lineWidth = 2;
      ctx.strokeStyle = '#ff4081';
      ctx.beginPath();
      const sliceWidth = visualizerCanvas.width / bufferLength;
      let x = 0;
      for (let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * visualizerCanvas.height / 2;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }
      ctx.lineTo(visualizerCanvas.width, visualizerCanvas.height / 2);
      ctx.stroke();
    }
    draw();
  }

  function stopVisualizer() {
    cancelAnimationFrame(animationId);
    visualizerCanvas.style.display = 'none';
    if (audioCtx) audioCtx.close();
  }

  async function startRecording() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioPlayer.src = URL.createObjectURL(audioBlob);
        uploadBtn.disabled = false;
        resetBtn.disabled = false;
        statusDiv.textContent = "‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
      };
      mediaRecorder.start();
      statusDiv.textContent = "üéôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
      showVisualizer(stream);
    } catch (err) {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ");
      console.error(err);
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
    }
    stopVisualizer();
  }

  async function uploadAudio() {
    if (!audioBlob) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
      return;
    }
    const name = nameInput.value.trim();
    const group = groupSelect.value;
    if (!name || !group) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
      return;
    }

    roseSpinner.style.display = 'block';
    statusDiv.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
    uploadBtn.disabled = true;

    const reader = new FileReader();
    reader.onloadend = async () => {
      const base64Audio = reader.result.split(',')[1];
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxE_TYcDqqheROL652jb8wHmg3K9IHujV6nwrXADVlYqX-RSJNfp1TfdyZdL4Zm7oODMw/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ name, group, audio: base64Audio })
        });
        const result = await response.json();
        if (result.success) {
          statusDiv.innerHTML = `üåπ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ô‡∏ô‡∏ô ‚ù§Ô∏è<br><a href="${result.url}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</a>`;
        } else {
          throw new Error(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        }
      } catch (err) {
        statusDiv.textContent = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
        uploadBtn.disabled = false;
      } finally {
        roseSpinner.style.display = 'none';
      }
    };
    reader.readAsDataURL(audioBlob);
  }

  greetingBtn.onclick = () => {
    if (greetingPlayed) return;
    const audio = new Audio("https://natiphol.github.io/33/Test.mp3");
    greetingBtn.disabled = true;
    audio.play();
    audio.onended = () => {
      greetingPlayed = true;
      startBtn.disabled = false;
      statusDiv.textContent = "‚úÖ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!";
    };
  };

  startBtn.onclick = () => {
    startBtn.disabled = true;
    greetingBtn.disabled = true;
    resetBtn.disabled = false;
    uploadBtn.disabled = true;
    startRecording();
  };

  resetBtn.onclick = () => {
    if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà? ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö")) return;
    stopRecording();
    audioPlayer.src = "";
    audioBlob = null;
    uploadBtn.disabled = true;
    startBtn.disabled = false;
    greetingBtn.disabled = true; // ‡∏´‡πâ‡∏≤‡∏°‡∏ü‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà
    statusDiv.textContent = "üîÅ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà";
  };

  uploadBtn.onclick = uploadAudio;
</script>

</body>
</html>
