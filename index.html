<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÉ‡∏´‡πâ‡∏ö‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏ß</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #e6f0ff;
      color: #003366;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      color: #003366;
      text-align: center;
    }
    select, input, button {
      font-size: 1rem;
      margin: 0.5rem 0;
      padding: 0.5rem;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #003366;
    }
    button {
      background-color: #004080;
      color: white;
      font-weight: bold;
    }
    button:disabled {
      background-color: #cccccc;
    }
    canvas {
      width: 100%;
      height: 60px;
      background: #ffffff;
      border: 1px solid #99c2ff;
      margin: 1rem 0;
      border-radius: 8px;
    }
    audio {
      width: 100%;
      margin-top: 1rem;
    }
    #greetingText {
      margin-top: 1rem;
      font-weight: bold;
      color: #0066cc;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>üì£ ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÉ‡∏´‡πâ‡∏ö‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏ß</h1>
  <label for="groupSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</label>
  <select id="groupSelect">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom-family">‡∏ç‡∏≤‡∏ï‡∏¥‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride-family">‡∏ç‡∏≤‡∏ï‡∏¥‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom-friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride-friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>

  <label for="nameInput">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ü‡∏•‡πå):</label>
  <input type="text" id="nameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô P_Nid_Friend"/>

  <button id="playGreetingBtn">‚ñ∂Ô∏è ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô</button>
  <button id="startBtn" disabled>üéô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
  <button id="stopBtn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button id="retryBtn">üîÅ ‡∏•‡∏≠‡∏á‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
  <button id="playBtn" disabled>üîä ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î</button>
  <button id="uploadBtn" disabled>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>

  <canvas id="audioVisualizer"></canvas>
  <audio id="audioPlayback" controls hidden></audio>
  <div id="greetingText">‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è</div>

  <script src="https://cdn.jsdelivr.net/npm/recorder-js@1.0.3/src/recorder.js"></script>
  <script>
    const playGreetingBtn = document.getElementById('playGreetingBtn');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const retryBtn = document.getElementById('retryBtn');
    const playBtn = document.getElementById('playBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const nameInput = document.getElementById('nameInput');
    const greetingText = document.getElementById('greetingText');
    const groupSelect = document.getElementById('groupSelect');
    const audioPlayback = document.getElementById('audioPlayback');
    const canvas = document.getElementById('audioVisualizer');
    const canvasCtx = canvas.getContext('2d');

    let mediaRecorder, recorderJS, audioChunks = [], audioBlob, audioUrl;
    let audioContext, analyser, sourceNode, animationId, recordTimeout;
    const MAX_RECORD_TIME_MS = 180000;
    const greetingAudio = new Audio('https://natiphol.github.io/33/Test.mp3');

    function drawVisualizer() {
      if (!analyser) return;
      const WIDTH = canvas.width;
      const HEIGHT = canvas.height;
      const bufferLength = analyser.fftSize;
      const dataArray = new Uint8Array(bufferLength);
      canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
      analyser.getByteTimeDomainData(dataArray);
      canvasCtx.lineWidth = 3;
      canvasCtx.strokeStyle = '#004080';
      canvasCtx.beginPath();
      const sliceWidth = WIDTH / bufferLength;
      let x = 0;
      for(let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * HEIGHT / 2;
        if(i === 0) canvasCtx.moveTo(x, y);
        else canvasCtx.lineTo(x, y);
        x += sliceWidth;
      }
      canvasCtx.lineTo(WIDTH, HEIGHT / 2);
      canvasCtx.stroke();
      animationId = requestAnimationFrame(drawVisualizer);
    }

    async function setupRecorder() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        sourceNode = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        sourceNode.connect(analyser);
        if (typeof MediaRecorder !== "undefined") {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = handleRecordingStop;
        } else {
          recorderJS = new Recorder(sourceNode, { numChannels: 1 });
        }
        return true;
      } catch (err) {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
        return false;
      }
    }

    function handleRecordingStop() {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioUrl = URL.createObjectURL(audioBlob);
      audioPlayback.src = audioUrl;
      audioPlayback.hidden = false;
      playBtn.disabled = false;
      uploadBtn.disabled = false;
      retryBtn.disabled = false;
      stopBtn.disabled = true;
      cancelAnimationFrame(animationId);
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
      clearTimeout(recordTimeout);
    }

    playGreetingBtn.addEventListener('click', async () => {
      greetingText.textContent = 'üéß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...';
      playGreetingBtn.disabled = true;
      await greetingAudio.play();
      greetingAudio.onended = () => {
        startBtn.disabled = false;
        greetingText.textContent = '‚úÖ ‡∏ü‡∏±‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ';
      };
    });

    startBtn.addEventListener('click', async () => {
      if (!groupSelect.value) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
      if (!nameInput.value.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠');
      if (!mediaRecorder && !recorderJS) {
        const ready = await setupRecorder();
        if (!ready) return;
      }
      greetingText.textContent = 'üéô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
      startBtn.disabled = true;
      stopBtn.disabled = false;
      retryBtn.disabled = true;
      playBtn.disabled = true;
      uploadBtn.disabled = true;
      audioChunks = [];
      drawVisualizer();
      if (mediaRecorder) mediaRecorder.start();
      else if (recorderJS) {
        recorderJS.clear();
        recorderJS.record();
      }
      recordTimeout = setTimeout(() => {
        stopBtn.click();
        greetingText.textContent = '‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ô‡∏≤‡∏ó‡∏µ';
      }, MAX_RECORD_TIME_MS);
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder?.state === 'recording') mediaRecorder.stop();
      else if (recorderJS) {
        recorderJS.stop();
        recorderJS.exportWAV(blob => {
          audioBlob = blob;
          audioUrl = URL.createObjectURL(audioBlob);
          audioPlayback.src = audioUrl;
          audioPlayback.hidden = false;
          playBtn.disabled = false;
          uploadBtn.disabled = false;
        });
      }
      greetingText.textContent = 'üìç ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß';
      cancelAnimationFrame(animationId);
      clearTimeout(recordTimeout);
      stopBtn.disabled = true;
      startBtn.disabled = false;
    });

    retryBtn.addEventListener('click', () => {
      audioPlayback.pause();
      audioPlayback.removeAttribute('src');
      audioPlayback.load();
      audioPlayback.hidden = true;
      playBtn.disabled = true;
      uploadBtn.disabled = true;
      retryBtn.disabled = true;
      greetingText.textContent = '‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è';
    });

    playBtn.addEventListener('click', () => {
      if (audioPlayback.src) audioPlayback.play().catch(() => {});
    });

    uploadBtn.addEventListener('click', async () => {
      if (!audioBlob || !nameInput.value.trim() || !groupSelect.value) return;
      const formData = new FormData();
      formData.append('audioBlob', audioBlob, 'voice.webm');
      formData.append('name', nameInput.value.trim());
      formData.append('group', groupSelect.value);
      uploadBtn.disabled = true;
      greetingText.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
      try {
        const response = await fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', {
          method: 'POST', body: formData
        });
        const text = await response.text();
        greetingText.textContent = text.includes('success')
          ? '‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì! ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
          : '‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
      } catch (err) {
        greetingText.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
      }
    });

    function resizeCanvas() {
      canvas.width = canvas.clientWidth * window.devicePixelRatio;
      canvas.height = canvas.clientHeight * window.devicePixelRatio;
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', resizeCanvas);
  </script>
</body>
</html>
