<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</title>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1rem; text-align: center; }
  button, select, input { font-size: 1rem; margin: 0.5rem; padding: 0.5rem; }
  #visualizer { width: 100%; height: 100px; border: 1px solid #ccc; margin-top: 1rem; }
  audio { width: 100%; margin-top: 1rem; display: none; }
</style>
</head>
<body>

<h2>üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</h2>

<select id="group">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
  <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
</select>
<input id="name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />

<br/>

<button id="playGreetingBtn">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô</button>
<button id="startRecordBtn" disabled>üéô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
<button id="stopRecordBtn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
<button id="playRecordBtn" disabled>üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î</button>
<button id="resetBtn" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>

<canvas id="visualizer" width="500" height="100"></canvas>
<audio id="recordedAudio" controls></audio>

<audio id="greetingAudio" preload="auto" src="https://natiphol.github.io/33/Test.mp3"></audio>

<script>
  const groupSelect = document.getElementById('group');
  const nameInput = document.getElementById('name');
  const playGreetingBtn = document.getElementById('playGreetingBtn');
  const startRecordBtn = document.getElementById('startRecordBtn');
  const stopRecordBtn = document.getElementById('stopRecordBtn');
  const playRecordBtn = document.getElementById('playRecordBtn');
  const resetBtn = document.getElementById('resetBtn');
  const recordedAudio = document.getElementById('recordedAudio');
  const greetingAudio = document.getElementById('greetingAudio');
  const canvas = document.getElementById('visualizer');
  const ctx = canvas.getContext('2d');

  let mediaRecorder;
  let audioChunks = [];
  let audioContext, analyser, source;
  let animationId;
  let recordTimeout;

  function drawVisualizer() {
    const bufferLength = analyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);

    function draw() {
      animationId = requestAnimationFrame(draw);
      analyser.getByteTimeDomainData(dataArray);

      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.lineWidth = 2;
      ctx.strokeStyle = '#1E90FF';
      ctx.beginPath();

      const sliceWidth = canvas.width / bufferLength;
      let x = 0;

      for(let i = 0; i < bufferLength; i++) {
        const v = dataArray[i] / 128.0;
        const y = v * canvas.height / 2;
        if(i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
        x += sliceWidth;
      }

      ctx.lineTo(canvas.width, canvas.height/2);
      ctx.stroke();
    }

    draw();
  }

  playGreetingBtn.onclick = () => {
    if (!groupSelect.value) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    if (!nameInput.value.trim()) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }

    playGreetingBtn.disabled = true;

    // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
    greetingAudio.play().catch(err => {
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ: ' + err.message);
      playGreetingBtn.disabled = false;
    });
  };

  greetingAudio.onended = () => {
    startRecordBtn.disabled = false;
    playGreetingBtn.textContent = '‚úÖ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
  };

  startRecordBtn.onclick = async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
      return;
    }

    startRecordBtn.disabled = true;
    stopRecordBtn.disabled = false;
    playRecordBtn.disabled = true;
    resetBtn.disabled = true;
    recordedAudio.style.display = 'none';
    audioChunks = [];

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);

      drawVisualizer();

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        cancelAnimationFrame(animationId);
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioUrl = URL.createObjectURL(audioBlob);
        recordedAudio.src = audioUrl;
        recordedAudio.style.display = 'block';
        playRecordBtn.disabled = false;
        resetBtn.disabled = false;
        stopRecordBtn.disabled = true;
        startRecordBtn.disabled = false;
        clearTimeout(recordTimeout);
      };

      mediaRecorder.start();

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ô‡∏≤‡∏ó‡∏µ
      recordTimeout = setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          alert('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á 3 ‡∏ô‡∏≤‡∏ó‡∏µ');
        }
      }, 3 * 60 * 1000);

    } catch (err) {
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ: ' + err.message);
      startRecordBtn.disabled = false;
      stopRecordBtn.disabled = true;
    }
  };

  stopRecordBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
  };

  playRecordBtn.onclick = () => {
    if (recordedAudio.src) {
      recordedAudio.play();
    }
  };

  resetBtn.onclick = () => {
    recordedAudio.src = '';
    recordedAudio.style.display = 'none';
    playRecordBtn.disabled = true;
    resetBtn.disabled = true;
  };
</script>

</body>
</html>
