<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iOS</title>
<style>
  body { font-family: "Kanit", sans-serif, Arial; max-width: 480px; margin: 2rem auto; padding: 1rem; background: #f0f6ff; color: #0a224a; text-align: center;}
  h1 { margin-bottom: 0.3rem;}
  p#status { margin: 0.5rem 0 1.2rem; font-weight: 600; color: #1a73e8;}
  select, input[type="text"] { font-size: 1rem; padding: 0.5rem 0.75rem; margin: 0.5rem 0; width: 100%; max-width: 300px; border-radius: 5px; border: 1.5px solid #aaa; outline-color: #1a73e8; box-sizing: border-box;}
  button { background-color: #1a73e8; color: white; border: none; border-radius: 5px; padding: 0.75rem 1.5rem; font-size: 1.1rem; margin: 0.3rem 0.5rem; cursor: pointer; transition: background-color 0.25s ease;}
  button:disabled { background-color: #a3c0f9; cursor: not-allowed;}
  audio#audioPlayback { width: 100%; margin-top: 0.5rem; outline: none; }
</style>
</head>
<body>
  <h1>üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö iOS</h1>
  <p id="status">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢"</p>

  <select id="group" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom-family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride-family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom-friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride-friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" aria-label="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />

  <div>
    <button id="playGreeting">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>
    <button id="startRecording" disabled>üéô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="stopRecording" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
    <button id="playAudio" disabled>üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î</button>
    <button id="retryRecording" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="uploadAudio" disabled>üì§ ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
  </div>

  <audio id="audioPlayback" controls style="display:none;"></audio>
  <audio id="greetingAudio" src="https://cdn.jsdelivr.net/gh/user/repo/greeting.mp3"></audio>

  <!-- ‡πÇ‡∏´‡∏•‡∏î Recorder.js ‡∏à‡∏≤‡∏Å CDN -->
  <script src="https://cdn.jsdelivr.net/npm/recorder-js@1.0.4/dist/recorder.min.js"></script>

  <script>
    const status = document.getElementById("status");
    const groupSelect = document.getElementById("group");
    const nameInput = document.getElementById("name");

    const playGreetingBtn = document.getElementById("playGreeting");
    const startBtn = document.getElementById("startRecording");
    const stopBtn = document.getElementById("stopRecording");
    const playBtn = document.getElementById("playAudio");
    const retryBtn = document.getElementById("retryRecording");
    const uploadBtn = document.getElementById("uploadAudio");

    const audioPlayback = document.getElementById("audioPlayback");
    const greetingAudio = document.getElementById("greetingAudio");

    let audioContext;
    let recorder;
    let audioBuffer;
    let recordingTimeout;
    const MAX_RECORDING_TIME = 180000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ

    // ‡πÄ‡∏ä‡πá‡∏Ñ iOS Safari ‡πÉ‡∏ä‡πâ Recorder.js
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    async function setupRecorder() {
      if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new Recorder(audioContext, { 
        // recorder.js config
        // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö WAV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏ô iOS ‡πÑ‡∏î‡πâ
        // ‡∏õ‡∏Å‡∏ï‡∏¥ Recorder.js ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ MediaStreamSource
        source: audioContext.createMediaStreamSource(stream)
      });
    }

    playGreetingBtn.onclick = () => {
      if (!groupSelect.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }
      if (!nameInput.value.trim()) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô");
        return;
      }
      playGreetingBtn.disabled = true;
      status.textContent = "üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...";
      greetingAudio.play();
    };

    greetingAudio.onended = () => {
      status.textContent = "üéô ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß";
      startBtn.disabled = false;
      playGreetingBtn.disabled = false;
    };

    greetingAudio.onerror = () => {
      alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ");
      playGreetingBtn.disabled = false;
      status.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    };

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      stopBtn.disabled = false;
      retryBtn.disabled = true;
      playBtn.disabled = true;
      uploadBtn.disabled = true;
      status.textContent = "üî¥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";

      try {
        if (!recorder) await setupRecorder();
        recorder.clear();
        recorder.start();

        // ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á 3 ‡∏ô‡∏≤‡∏ó‡∏µ
        recordingTimeout = setTimeout(() => {
          if (stopBtn.disabled === false) stopRecording();
        }, MAX_RECORDING_TIME);

      } catch (e) {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô");
        resetButtons();
      }
    };

    function stopRecording() {
      stopBtn.disabled = true;
      recorder.stop().then(({blob, buffer}) => {
        audioBuffer = buffer;
        const url = URL.createObjectURL(blob);
        audioPlayback.src = url;
        audioPlayback.style.display = "block";
        playBtn.disabled = false;
        uploadBtn.disabled = false;
        retryBtn.disabled = false;
        status.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
        clearTimeout(recordingTimeout);
      });
    }

    stopBtn.onclick = () => {
      stopRecording();
    };

    playBtn.onclick = () => {
      audioPlayback.play();
    };

    retryBtn.onclick = () => {
      audioPlayback.src = "";
      audioPlayback.style.display = "none";
      playBtn.disabled = true;
      retryBtn.disabled = true;
      uploadBtn.disabled = true;
      status.textContent = "üîÑ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
      startBtn.disabled = true;
      stopBtn.disabled = true;
    };

    uploadBtn.onclick = async () => {
      if (!audioPlayback.src) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á");
        return;
      }
      uploadBtn.disabled = true;
      uploadBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

      try {
        // ‡∏î‡∏∂‡∏á blob ‡∏à‡∏≤‡∏Å URL
        const response = await fetch(audioPlayback.src);
        const blob = await response.blob();

        const formData = new FormData();
        // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© + ‡∏Å‡∏•‡∏∏‡πà‡∏°
        const safeName = nameInput.value.trim().replace(/[^a-zA-Z0-9]/g, "_");
        formData.append("audio", blob, `voice_${safeName}_${groupSelect.value}.wav`);
        formData.append("name", nameInput.value.trim());
        formData.append("group", groupSelect.value);

        const res = await fetch("/upload", {
          method: "POST",
          body: formData,
        });
        const json = await res.json();
        if (json.success) {
          alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö!");
          status.textContent = "‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á!";
          uploadBtn.disabled = true;
          uploadBtn.textContent = "üì§ ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
          retryBtn.disabled = true;
          playBtn.disabled = true;
          startBtn.disabled = true;
          stopBtn.disabled = true;
        } else {
          throw new Error(json.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        }
      } catch (err) {
        alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message);
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "üì§ ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
      }
    };

    function resetButtons() {
      startBtn.disabled = false;
      stopBtn.disabled = true;
      retryBtn.disabled = true;
      playBtn.disabled = true;
      uploadBtn.disabled = true;
      status.textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
    }
  </script>
</body>
</html>
