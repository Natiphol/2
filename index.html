<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
<style>
  body {
    font-family: 'Prompt', sans-serif, Arial, sans-serif;
    background: #f0f8ff;
    color: #003366;
    padding: 20px;
    max-width: 420px;
    margin: auto;
  }
  h1 {
    text-align: center;
    color: #004080;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  select, input[type=text] {
    width: 100%;
    padding: 10px;
    font-size: 1.1rem;
    border-radius: 10px;
    border: 2px solid #aaccee;
    margin-top: 5px;
    box-sizing: border-box;
  }
  button {
    margin-top: 15px;
    width: 100%;
    background-color: #004080;
    color: white;
    border: none;
    padding: 14px;
    font-size: 1.2rem;
    border-radius: 12px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #aaccee;
    cursor: not-allowed;
  }
  audio {
    margin-top: 15px;
    width: 100%;
  }
  canvas {
    width: 100%;
    height: 60px;
    margin-top: 15px;
    background: #cce7ff;
    border-radius: 12px;
  }
  #message {
    margin-top: 15px;
    font-weight: bold;
    color: #004080;
    text-align: center;
  }
</style>
</head>
<body>

<h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>

<label for="group">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
<select id="group">
  <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
  <option value="groom_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
</select>

<label for="name">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
<input id="name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />

<button id="playGreetingBtn">üì¢ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏î</button>
<button id="startRecordBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
<button id="stopRecordBtn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î</button>
<button id="retryBtn" disabled>üîÑ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
<button id="playBtn" disabled>‚ñ∂ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î</button>
<button id="uploadBtn" disabled>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>

<canvas id="visualizer"></canvas>
<audio id="audioPlayback" controls></audio>

<div id="message"></div>

<!-- Recorder.js CDN ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fallback iOS -->
<script src="https://cdn.jsdelivr.net/npm/recorder-js@1.0.3/dist/recorder.min.js"></script>

<script>
  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ DOM
  const group = document.getElementById('group');
  const nameInput = document.getElementById('name');
  const playGreetingBtn = document.getElementById('playGreetingBtn');
  const startRecordBtn = document.getElementById('startRecordBtn');
  const stopRecordBtn = document.getElementById('stopRecordBtn');
  const retryBtn = document.getElementById('retryBtn');
  const playBtn = document.getElementById('playBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const audioPlayback = document.getElementById('audioPlayback');
  const visualizer = document.getElementById('visualizer');
  const message = document.getElementById('message');
  const canvasCtx = visualizer.getContext('2d');

  // ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
  const greetingAudio = new Audio('https://natiphol.github.io/33/Test.mp3');

  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ audio context, mediaRecorder, recorderJS, etc.
  let audioContext, analyser, sourceNode, animationId;
  let mediaRecorder, audioChunks = [];
  let recorderJS, recorderJSStream, audioContextJS;
  let recordedBlob;
  let isRecording = false;
  let maxRecordTimeMs = 240000; // 4 ‡∏ô‡∏≤‡∏ó‡∏µ
  let recordTimeout;

  // ‡πÄ‡∏ä‡πá‡∏Ñ iOS
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô resize canvas
  function resizeCanvas() {
    visualizer.width = visualizer.clientWidth * window.devicePixelRatio;
    visualizer.height = visualizer.clientHeight * window.devicePixelRatio;
  }
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('load', () => {
    resizeCanvas();
    checkFormValidity();
  });

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏≤‡∏î visualizer
  function drawVisualizer() {
    if (!analyser) return;
    const WIDTH = visualizer.width;
    const HEIGHT = visualizer.height;
    const bufferLength = analyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteTimeDomainData(dataArray);

    canvasCtx.fillStyle = '#cce7ff';
    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

    canvasCtx.lineWidth = 3;
    canvasCtx.strokeStyle = '#004080';
    canvasCtx.beginPath();

    const sliceWidth = WIDTH / bufferLength;
    let x = 0;

    for(let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] / 128.0;
      const y = v * HEIGHT/2;
      if(i === 0) {
        canvasCtx.moveTo(x, y);
      } else {
        canvasCtx.lineTo(x, y);
      }
      x += sliceWidth;
    }

    canvasCtx.lineTo(WIDTH, HEIGHT/2);
    canvasCtx.stroke();

    animationId = requestAnimationFrame(drawVisualizer);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö
  function checkFormValidity() {
    if(group.value && nameInput.value.trim() !== '') {
      playGreetingBtn.disabled = false;
    } else {
      playGreetingBtn.disabled = true;
      startRecordBtn.disabled = true;
    }
  }

  group.addEventListener('change', checkFormValidity);
  nameInput.addEventListener('input', checkFormValidity);

  // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏î
  playGreetingBtn.onclick = () => {
    playGreetingBtn.disabled = true;
    startRecordBtn.disabled = true;
    message.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...';

    greetingAudio.play();
    greetingAudio.onended = () => {
      message.textContent = '‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß';
      startRecordBtn.disabled = false;
      playGreetingBtn.disabled = false;
    };
  };

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  startRecordBtn.onclick = async () => {
    if (isRecording) return;

    if (!group.value) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
      return;
    }
    if (!nameInput.value.trim()) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©');
      return;
    }

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
    audioChunks = [];
    recordedBlob = null;
    audioPlayback.src = '';
    playBtn.disabled = true;
    uploadBtn.disabled = true;
    retryBtn.disabled = true;

    // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    try {
      message.textContent = '‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô...';

      if (isIOS) {
        // fallback Recorder.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iOS
        recorderJSStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContextJS = new AudioContext();
        recorderJS = new Recorder(audioContextJS.createMediaStreamSource(recorderJSStream), { numChannels: 1 });
        recorderJS.start();

        audioContext = audioContextJS;
        analyser = audioContextJS.createAnalyser();
        analyser.fftSize = 2048;
        recorderJS.source.connect(analyser);

        drawVisualizer();

      } else {
        // ‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ä‡πâ MediaRecorder
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new AudioContext();
        sourceNode = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        sourceNode.connect(analyser);
        drawVisualizer();

        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => {
          audioChunks.push(e.data);
        };
        mediaRecorder.start();
      }

      isRecording = true;
      message.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡∏à‡∏≥‡∏Å‡∏±‡∏î 4 ‡∏ô‡∏≤‡∏ó‡∏µ)';
      startRecordBtn.disabled = true;
      stopRecordBtn.disabled = false;
      playGreetingBtn.disabled = true;

      // ‡∏ï‡∏±‡πâ‡∏á timeout ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö 4 ‡∏ô‡∏≤‡∏ó‡∏µ
      recordTimeout = setTimeout(() => {
        stopRecording();
      }, maxRecordTimeMs);

    } catch (err) {
      message.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ';
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    }
  };

  // ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  stopRecordBtn.onclick = () => {
    stopRecording();
  };

  function stopRecording() {
    if (!isRecording) return;

    if (isIOS && recorderJS) {
      recorderJS.stop().then(({blob}) => {
        recordedBlob = blob;
        afterRecordStop();
      });
    } else if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
      afterRecordStop();
    }

    if (audioContext) {
      audioContext.suspend();
    }
    isRecording = false;
    stopRecordBtn.disabled = true;
    startRecordBtn.disabled = true;
    playGreetingBtn.disabled = false;

    clearTimeout(recordTimeout);
  }

  function afterRecordStop() {
    message.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ü‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ';
    playBtn.disabled = false;
    retryBtn.disabled = false;
    uploadBtn.disabled = false;

    if (recordedBlob) {
      const url = URL.createObjectURL(recordedBlob);
      audioPlayback.src = url;
    }

    cancelAnimationFrame(animationId);
    canvasCtx.clearRect(0, 0, visualizer.width, visualizer.height);
  }

  // ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î
  playBtn.onclick = () => {
    if (audioPlayback.src) {
      audioPlayback.play();
    }
  };

  // ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
  retryBtn.onclick = () => {
    audioChunks = [];
    recordedBlob = null;
    audioPlayback.src = '';
    playBtn.disabled = true;
    uploadBtn.disabled = true;
    retryBtn.disabled = true;
    message.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà';
    startRecordBtn.disabled = true;
  };

  // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÅ‡∏Ñ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)
  uploadBtn.onclick = () => {
    if (!recordedBlob) {
      alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á');
      return;
    }
    if (!group.value || !nameInput.value.trim()) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      return;
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    const cleanName = nameInput.value.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
    const filename = `${group.value}_${cleanName}.webm`;

    message.textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå: ${filename}`;
    alert('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏á');
  };

</script>
</body>
</html>
