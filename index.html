<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢ Jarvis</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f6ff;
      color: #1a1a1a;
      margin: 0; padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      background: white;
      max-width: 420px;
      width: 100%;
      padding: 2rem 2.5rem;
      border-radius: 16px;
      box-shadow: 0 15px 40px rgba(58, 87, 151, 0.15);
    }

    h1 {
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #1c3aa9;
      text-align: center;
    }

    label {
      display: block;
      font-weight: 600;
      margin: 1rem 0 0.5rem;
      color: #3e4a8e;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: 1.8px solid #a8b9ff;
      border-radius: 8px;
      outline-offset: 2px;
      transition: border-color 0.3s ease;
    }

    select:focus, input[type="text"]:focus {
      border-color: #1c3aa9;
      box-shadow: 0 0 8px #aecbffaa;
    }

    .btn-group {
      margin-top: 2rem;
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      background: #3a5fe7;
      color: white;
      border: none;
      padding: 0.85rem 1.8rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 5px 12px rgba(58, 95, 231, 0.3);
      transition: background-color 0.25s ease;
      flex: 1 1 140px;
      user-select: none;
    }

    button:hover:not(:disabled) {
      background-color: #1c3aa9;
    }

    button:disabled {
      background-color: #a1b1dd;
      cursor: not-allowed;
      box-shadow: none;
    }

    #visualizer {
      width: 100%;
      height: 80px;
      border-radius: 12px;
      background: #e8ecff;
      margin-top: 1.5rem;
      box-shadow: inset 0 0 12px #a5baff;
    }

    audio {
      width: 100%;
      margin-top: 1.5rem;
      border-radius: 12px;
      outline: none;
      box-shadow: 0 0 10px #aecbffcc;
    }

    #statusText {
      margin-top: 1rem;
      font-weight: 600;
      color: #3a5fe7;
      text-align: center;
      min-height: 1.2em;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>üé§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢ Jarvis</h1>

    <label for="group">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
    <select id="group">
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
      <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
      <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    </select>

    <label for="name">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
    <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)" pattern="[A-Za-z\s]+" />

    <div class="btn-group">
      <button id="playGreeting">‚ñ∂Ô∏è ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>
      <button id="startRecord" disabled>üî¥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
      <button id="stopRecord" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button id="playRecord" disabled>üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button id="uploadRecord" disabled>üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå</button>
    </div>

    <canvas id="visualizer"></canvas>

    <audio id="audioPlayback" controls style="display:none"></audio>

    <div id="statusText"></div>
  </div>

  <script>
    // URL ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
    const greetingUrl = "https://natiphol.github.io/33/Test.mp3";

    const groupEl = document.getElementById("group");
    const nameEl = document.getElementById("name");
    const playGreetingBtn = document.getElementById("playGreeting");
    const startRecordBtn = document.getElementById("startRecord");
    const stopRecordBtn = document.getElementById("stopRecord");
    const playRecordBtn = document.getElementById("playRecord");
    const uploadRecordBtn = document.getElementById("uploadRecord");
    const visualizer = document.getElementById("visualizer");
    const audioPlayback = document.getElementById("audioPlayback");
    const statusText = document.getElementById("statusText");

    const MAX_RECORD_TIME = 3 * 60 * 1000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ

    let audioContext, analyser, sourceNode, animationId;
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á AudioContext ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö visualizer
    function setupVisualizer(stream) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      sourceNode = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      sourceNode.connect(analyser);
      drawVisualizer();
    }

    // ‡∏ß‡∏≤‡∏î‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    function drawVisualizer() {
      const canvasCtx = visualizer.getContext("2d");
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        canvasCtx.fillStyle = "#e8ecff";
        canvasCtx.fillRect(0, 0, visualizer.width, visualizer.height);

        canvasCtx.lineWidth = 2;
        canvasCtx.strokeStyle = "#3a5fe7";
        canvasCtx.beginPath();

        let sliceWidth = visualizer.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          let v = dataArray[i] / 128.0;
          let y = (v * visualizer.height) / 2;
          if (i === 0) {
            canvasCtx.moveTo(x, y);
          } else {
            canvasCtx.lineTo(x, y);
          }
          x += sliceWidth;
        }
        canvasCtx.lineTo(visualizer.width, visualizer.height / 2);
        canvasCtx.stroke();
      }
      draw();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ MediaRecorder
    async function initMediaRecorder() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        setupVisualizer(stream);
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          audioChunks = [];
          audioPlayback.src = URL.createObjectURL(audioBlob);
          audioPlayback.style.display = "block";
          playRecordBtn.disabled = false;
          uploadRecordBtn.disabled = false;
          statusText.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô";
        };
        statusText.textContent = "‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
        startRecordBtn.disabled = false;
      } catch (err) {
        statusText.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ";
        console.error(err);
      }
    }

    // ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô)
    playGreetingBtn.addEventListener("click", () => {
      statusText.textContent = "‚ñ∂Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...";
      const audio = new Audio(greetingUrl);
      playGreetingBtn.disabled = true;
      startRecordBtn.disabled = true;
      stopRecordBtn.disabled = true;
      playRecordBtn.disabled = true;
      uploadRecordBtn.disabled = true;

      audio.play();
      audio.onended = () => {
        statusText.textContent = "‚úÖ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ";
        startRecordBtn.disabled = false;
        playGreetingBtn.disabled = false;
      };
      audio.onerror = () => {
        statusText.textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÑ‡∏î‡πâ";
        playGreetingBtn.disabled = false;
      };
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    startRecordBtn.addEventListener("click", async () => {
      if (!groupEl.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
        return;
      }
      if (!nameEl.value.trim() || !/^[A-Za-z\s]+$/.test(nameEl.value.trim())) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        return;
      }
      if (!mediaRecorder) {
        await initMediaRecorder();
      }
      audioPlayback.style.display = "none";
      audioPlayback.pause();
      audioChunks = [];
      mediaRecorder.start();
      statusText.textContent = "‚è∫Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
      startRecordBtn.disabled = true;
      stopRecordBtn.disabled = false;
      playGreetingBtn.disabled = true;
      playRecordBtn.disabled = true;
      uploadRecordBtn.disabled = true;

      // ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö 3 ‡∏ô‡∏≤‡∏ó‡∏µ
      setTimeout(() => {
        if (mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          stopRecordBtn.disabled = true;
          startRecordBtn.disabled = false;
          playGreetingBtn.disabled = false;
          statusText.textContent = "‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß";
        }
      }, MAX_RECORD_TIME);
    });

    // ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    stopRecordBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        statusText.textContent = "‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß";
        stopRecordBtn.disabled = true;
        startRecordBtn.disabled = false;
        playGreetingBtn.disabled = false;
      }
    });

    // ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    playRecordBtn.addEventListener("click", () => {
      if (audioBlob) {
        audioPlayback.play();
      }
    });

    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Google Drive
    uploadRecordBtn.addEventListener("click", async () => {
      if (!audioBlob) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á");
        return;
      }
      if (!groupEl.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
        return;
      }
      if (!nameEl.value.trim()) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
        return;
      }
      uploadRecordBtn.disabled = true;
      uploadRecordBtn.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

      try {
        const formData = new FormData();
        formData.append("audio", audioBlob, `${nameEl.value.trim()}_${groupEl.value}.webm`);
        formData.append("name", nameEl.value.trim());
        formData.append("group", groupEl.value);

        // TODO: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÄ‡∏õ‡πá‡∏ô API ‡∏Ç‡∏≠‡∏á server ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ Google Drive
        const response = await fetch("YOUR_SERVER_UPLOAD_ENDPOINT_HERE", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();
        if (result.success) {
          statusText.textContent = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á!";
          alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á!");
          // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°
          uploadRecordBtn.disabled = false;
          uploadRecordBtn.textContent = "üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå";
          playRecordBtn.disabled = true;
          audioPlayback.style.display = "none";
          audioPlayback.src = "";
        } else {
          throw new Error(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        }
      } catch (err) {
        alert("‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        uploadRecordBtn.disabled = false;
        uploadRecordBtn.textContent = "üì§ ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå";
      }
    });

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö device pixel ratio
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      visualizer.width = visualizer.clientWidth * dpr;
      visualizer.height = visualizer.clientHeight * dpr;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ media recorder
    initMediaRecorder();

  </script>
</body>
</html>
