<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
  <style>
    /* (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠) */
    /* ...CSS ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î... */
  </style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/n0DtfkQ.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á" width="150" />
  </header>
  <div class="container">
    <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>
    <label for="groupSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
    <select id="groupSelect">
      <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
      <option value="groom_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_family">‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
      <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
      <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    </select>
    <label for="nameInput">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)</label>
    <input id="nameInput" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)" />
    <div class="greeting" id="greetingText">
      ‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è
    </div>
    <canvas id="audioVisualizer"></canvas>
    <div class="buttons-row">
      <button id="playGreetingBtn">üì¢ ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>
      <button id="startBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
      <button id="stopBtn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
      <button id="retryBtn" disabled>üîÑ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
      <button id="playBtn" disabled>‚ñ∂ ‡∏ü‡∏±‡∏á</button>
      <button id="uploadBtn" disabled>üì§ ‡πÅ‡∏ä‡∏£‡πå / ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
    </div>
    <audio id="audioPlayback" class="audio-player" controls></audio>
  </div>

<script>
const playGreetingBtn = document.getElementById('playGreetingBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const retryBtn = document.getElementById('retryBtn');
const playBtn = document.getElementById('playBtn');
const uploadBtn = document.getElementById('uploadBtn');
const nameInput = document.getElementById('nameInput');
const groupSelect = document.getElementById('groupSelect');
const greetingText = document.getElementById('greetingText');
const audioPlayback = document.getElementById('audioPlayback');
const canvas = document.getElementById('audioVisualizer');
const canvasCtx = canvas.getContext('2d');

let mediaRecorder, audioChunks = [], audioBlob, audioUrl;
let audioContext, analyser, sourceNode, animationId, recordTimeout;
const MAX_RECORD_TIME_MS = 180000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ
const greetingAudio = new Audio('https://natiphol.github.io/33/Test.mp3');

function drawVisualizer() {
  if (!analyser) return;
  const WIDTH = canvas.width;
  const HEIGHT = canvas.height;
  const bufferLength = analyser.fftSize;
  const dataArray = new Uint8Array(bufferLength);
  canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);
  analyser.getByteTimeDomainData(dataArray);
  canvasCtx.lineWidth = 3;
  canvasCtx.strokeStyle = '#004080';
  canvasCtx.beginPath();
  const sliceWidth = WIDTH / bufferLength;
  let x = 0;
  for (let i = 0; i < bufferLength; i++) {
    const v = dataArray[i] / 128.0;
    const y = v * HEIGHT / 2;
    if (i === 0) canvasCtx.moveTo(x, y);
    else canvasCtx.lineTo(x, y);
    x += sliceWidth;
  }
  canvasCtx.lineTo(WIDTH, HEIGHT / 2);
  canvasCtx.stroke();
  animationId = requestAnimationFrame(drawVisualizer);
}

async function setupRecorder() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioContext = new AudioContext();
    sourceNode = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    sourceNode.connect(analyser);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = async () => {
      audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioUrl = URL.createObjectURL(audioBlob);
      audioPlayback.src = audioUrl;
      await audioPlayback.play().catch(() => {});
      playBtn.disabled = false;
      uploadBtn.disabled = false;
      retryBtn.disabled = false;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      cancelAnimationFrame(animationId);
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
      clearTimeout(recordTimeout);
    };
    return true;
  } catch (err) {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï');
    return false;
  }
}

playGreetingBtn.addEventListener('click', async () => {
  greetingText.textContent = 'üéß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...';
  playGreetingBtn.disabled = true;
  await greetingAudio.play();
  greetingAudio.onended = () => {
    greetingText.textContent = '‚úÖ ‡∏ü‡∏±‡∏á‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ';
    startBtn.disabled = false;
  };
});

startBtn.addEventListener('click', async () => {
  if (!groupSelect.value) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
  if (!nameInput.value.trim()) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠');
  if (!mediaRecorder) {
    const ready = await setupRecorder();
    if (!ready) return;
  }
  greetingText.textContent = 'üéô ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
  startBtn.disabled = true;
  audioChunks = [];
  mediaRecorder.start();
  stopBtn.disabled = false;
  retryBtn.disabled = true;
  playBtn.disabled = true;
  uploadBtn.disabled = true;
  drawVisualizer();
  recordTimeout = setTimeout(() => {
    if (mediaRecorder?.state === 'recording') {
      mediaRecorder.stop();
      greetingText.textContent = '‚è∞ ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ô‡∏≤‡∏ó‡∏µ';
    }
  }, MAX_RECORD_TIME_MS);
});

stopBtn.addEventListener('click', () => {
  if (mediaRecorder?.state === 'recording') {
    mediaRecorder.stop();
    greetingText.textContent = 'üìç ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß';
  }
});

retryBtn.addEventListener('click', () => {
  audioPlayback.pause();
  audioPlayback.removeAttribute('src');
  audioPlayback.load();
  playBtn.disabled = true;
  uploadBtn.disabled = true;
  retryBtn.disabled = true;
  greetingText.textContent = '‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è';
});

playBtn.addEventListener('click', async () => {
  if (audioPlayback.src) {
    await audioPlayback.play().catch(() => {});
  }
});

uploadBtn.addEventListener('click', async () => {
  if (!audioBlob || !nameInput.value.trim() || !groupSelect.value) return;
  const formData = new FormData();
  const name = nameInput.value.trim().replace(/[^a-zA-Z0-9_-]/g, '_');
  const group = groupSelect.value;
  const filename = `${group}_${name}.webm`;
  formData.append('audio', audioBlob, filename);
  formData.append('group', group);
  uploadBtn.disabled = true;
  greetingText.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...';
  try {
    const response = await fetch('https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', {
      method: 'POST',
      body: formData,
    });
    const result = await response.text();
    greetingText.textContent = result.includes('success')
      ? '‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì! ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
      : '‚ùå ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î';
  } catch (err) {
    greetingText.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message;
  }
});

function resizeCanvas() {
  canvas.width = canvas.clientWidth * window.devicePixelRatio;
  canvas.height = canvas.clientHeight * window.devicePixelRatio;
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('load', resizeCanvas);
</script>
</body>
</html>
