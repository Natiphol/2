<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
    }
    select, input, button {
      margin: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
    audio {
      display: block;
      margin: 1rem auto;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/mattdiamond/Recorderjs/recorder.js"></script>
</head>
<body>
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</h1>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡πâ‡∏≤‡πÅ‡∏≠‡πä‡∏î)" />
  <select id="group">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select><br/>
  <button id="startBtn">üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
  <button id="stopBtn" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
  <button id="uploadBtn" disabled>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
  <audio id="audioPlayer" controls></audio>
  <div id="status"></div>

  <script>
    let useFallback = false;
    let recorder;
    let audioBlob;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const audioPlayer = document.getElementById("audioPlayer");
    const statusDiv = document.getElementById("status");

    let mediaRecorder;
    let audioChunks = [];

    async function initRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      if (typeof MediaRecorder === "undefined" || /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        // ‡πÉ‡∏ä‡πâ fallback (iOS Safari)
        useFallback = true;
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const input = audioContext.createMediaStreamSource(stream);
        recorder = new Recorder(input, { numChannels: 1 });
        recorder.record();
      } else {
        // ‡πÉ‡∏ä‡πâ MediaRecorder ‡∏õ‡∏Å‡∏ï‡∏¥
        useFallback = false;
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          audioPlayer.src = URL.createObjectURL(audioBlob);
          audioPlayer.load();
        };
        mediaRecorder.start();
      }
    }

    startBtn.onclick = async () => {
      await initRecording();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      uploadBtn.disabled = true;
      statusDiv.innerText = "üéôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
    };

    stopBtn.onclick = () => {
      if (useFallback) {
        recorder.stop();
        recorder.exportWAV(blob => {
          audioBlob = blob;
          audioPlayer.src = URL.createObjectURL(blob);
          audioPlayer.load();
        });
      } else {
        mediaRecorder.stop();
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
      uploadBtn.disabled = false;
      statusDiv.innerText = "‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß";
    };

    uploadBtn.onclick = async () => {
      const name = document.getElementById('name').value.trim();
      const group = document.getElementById('group').value;

      if (!name || !group) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
        return;
      }

      statusDiv.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";
      uploadBtn.disabled = true;

      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Audio = reader.result.split(',')[1];

        try {
          const response = await fetch("https://script.google.com/macros/s/AKfycbxE_TYcDqqheROL652jb8wHmg3K9IHujV6nwrXADVlYqX-RSJNfp1TfdyZdL4Zm7oODMw/exec", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
              name,
              group,
              audio: base64Audio
            })
          });

          const result = await response.json();
          if (result.success) {
            statusDiv.innerHTML = `‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br><a href="${result.url}" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</a>`;
          } else {
            throw new Error(result.message);
          }
        } catch (err) {
          console.error(err);
          statusDiv.innerText = "‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message;
        }
      };
      reader.readAsDataURL(audioBlob);
    };
  </script>
</body>
</html>
