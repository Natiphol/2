<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á (‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á iOS)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Kanit&display=swap');
  body {
    font-family: 'Kanit', sans-serif;
    max-width: 420px;
    margin: 2rem auto;
    padding: 1rem;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    text-align: center;
  }
  img.logo {
    display: block;
    margin: 0 auto 1rem auto;
    max-width: 120px;
    border-radius: 10px;
  }
  h1 {
    margin-bottom: 1rem;
  }
  input, select, button {
    font-size: 1rem;
    padding: 0.6rem;
    margin: 0.5rem 0;
    width: 100%;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    background-color: #0066cc;
    color: white;
    border: none;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background-color: #004999;
  }
  audio {
    margin-top: 1rem;
    width: 100%;
  }
  #status {
    margin-top: 1rem;
    min-height: 2rem;
    font-weight: 600;
    color: #333;
  }
  #timer {
    font-weight: bold;
    margin-top: 0.3rem;
    color: #d9534f;
  }
  #visualizer {
    margin: 1rem auto;
    width: 100%;
    height: 70px;
    background: linear-gradient(90deg, #f7cac9, #92a8d1);
    border-radius: 10px;
  }
  /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà */
  #buttonsContainer {
    display: flex;
    gap: 10px;
    margin-top: 0.5rem;
  }
  #buttonsContainer button {
    flex: 1;
  }
  /* ‡∏£‡∏π‡∏õ‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö‡πÇ‡∏´‡∏•‡∏î */
  #progressRose {
    margin: 1rem auto 0;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/Clj3TTe.png'); /* ‡∏£‡∏π‡∏õ‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏° */
    background-size: cover;
    animation: spin 1.2s linear infinite;
    display: none;
  }
  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }
</style>
</head>
<body>

<img src="https://i.imgur.com/n0DtfkQ.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á" class="logo" />

<h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á</h1>

<input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)" />
<select id="group" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
  <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
  <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
</select>

<button id="playGreetingBtn">‚ñ∂Ô∏è ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢</button>

<div id="buttonsContainer">
  <button id="startBtn" disabled>üé§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
  <button id="stopBtn" disabled>‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
  <button id="uploadBtn" disabled>üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
  <button id="resetBtn" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
</div>

<div id="timer"></div>
<canvas id="visualizer"></canvas>

<audio id="audioPlayer" controls></audio>
<div id="status"></div>
<div id="progressRose"></div>

<script>
  const playGreetingBtn = document.getElementById('playGreetingBtn');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const resetBtn = document.getElementById('resetBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const statusDiv = document.getElementById('status');
  const timerDiv = document.getElementById('timer');
  const nameInput = document.getElementById('name');
  const groupSelect = document.getElementById('group');
  const progressRose = document.getElementById('progressRose');

  const canvas = document.getElementById('visualizer');
  const ctx = canvas.getContext('2d');
  let animationId;

  let mediaRecorder;
  let audioChunks = [];
  let audioBlob;
  let stream;
  let recordingTimer;
  const maxRecordingTime = 180; // ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (3 ‡∏ô‡∏≤‡∏ó‡∏µ)
  let timeElapsed = 0;

  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î canvas size ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á
  function resizeCanvas() {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  // Visualizer variables
  let audioContext;
  let analyser;
  let sourceNode;

  // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
  let greetingPlayed = false;

  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  nameInput.addEventListener('input', () => {
    nameInput.value = nameInput.value.replace(/[^a-zA-Z ]/g, '');
  });

  function updateTimer() {
    timeElapsed++;
    const minutes = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
    const seconds = (timeElapsed % 60).toString().padStart(2, '0');
    timerDiv.textContent = `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${minutes}:${seconds}`;
    if (timeElapsed >= maxRecordingTime) {
      stopRecording();
    }
  }

  async function startRecording() {
    if (!nameInput.value.trim()) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
      return;
    }
    if (!/^[a-zA-Z ]+$/.test(nameInput.value.trim())) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
      return;
    }
    if (!groupSelect.value) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
      alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô");
      console.error(err);
      return;
    }

    audioChunks = [];
    
    let mimeType = '';
    if (MediaRecorder.isTypeSupported('audio/mp4')) {
      mimeType = 'audio/mp4';
    } else if (MediaRecorder.isTypeSupported('audio/webm')) {
      mimeType = 'audio/webm';
    } else if (MediaRecorder.isTypeSupported('audio/wav')) {
      mimeType = 'audio/wav';
    } else {
      mimeType = '';
    }
    
    mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      audioBlob = new Blob(audioChunks, { type: mimeType || 'audio/webm' });
      const audioUrl = URL.createObjectURL(audioBlob);
      audioPlayer.src = audioUrl;
      audioPlayer.load();
      uploadBtn.disabled = false;
      resetBtn.disabled = false;
      statusDiv.textContent = "‚úÖ ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
      stopBtn.disabled = true;
      startBtn.disabled = false;
      clearVisualizer();
      if (recordingTimer) clearInterval(recordingTimer);
      timerDiv.textContent = "";
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
    };

    mediaRecorder.start();
    statusDiv.textContent = "üéôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
    startBtn.disabled = true;
    stopBtn.disabled = false;
    uploadBtn.disabled = true;
    resetBtn.disabled = true;
    playGreetingBtn.disabled = true;

    timeElapsed = 0;
    timerDiv.textContent = "‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: 00:00";
    recordingTimer = setInterval(updateTimer, 1000);

    startVisualizer();
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }
    stopBtn.disabled = true;
  }

  function resetRecording() {
    if (confirm("üîÅ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö")) {
      resetUI();
      // ‡∏ï‡∏≠‡∏ô‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏≠‡∏µ‡∏Å (‡∏Å‡∏î‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°)
      greetingPlayed = true;
      playGreetingBtn.disabled = true;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      resetBtn.disabled = true;
      uploadBtn.disabled = true;
      audioPlayer.src = "";
      timerDiv.textContent = "";
      statusDiv.textContent = "üîÅ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢";
    }
  }

  // ‡πÄ‡∏£‡∏¥‡πà‡∏° visualizer ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ô‡∏≠‡∏±‡∏î
  function startVisualizer() {
    if (audioContext) {
      audioContext.close();
    }
    audioContext = new AudioContext();
    analyser = audioContext.createAnalyser();
    sourceNode = audioContext.createMediaStreamSource(stream);
    sourceNode.connect(analyser);
    analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);

    function draw() {
      animationId = requestAnimationFrame(draw);
      analyser.getByteFrequencyData(dataArray);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const barWidth = (canvas.width / bufferLength) * 1.5;
      let x = 0;
      for(let i = 0; i < bufferLength; i++) {
        const barHeight = dataArray[i]/2;
        const r = 250;
        const g = 100;
        const b = 100;
        ctx.fillStyle = `rgb(${r},${g},${b})`;
        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
        x += barWidth + 1;
      }
    }
    draw();
  }

  function clearVisualizer() {
    if (animationId) cancelAnimationFrame(animationId);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  // ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢
  playGreetingBtn.addEventListener('click', () => {
    const greetingAudio = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
    // ‡πÅ‡∏ó‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    greetingAudio.play();
    greetingAudio.onended = () => {
      greetingPlayed = true;
      startBtn.disabled = false;
      playGreetingBtn.disabled = true;
      statusDiv.textContent = "‚úÖ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ";
    };
    playGreetingBtn.disabled = true;
    statusDiv.textContent = "‚ñ∂Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...";
  });

  startBtn.addEventListener('click', startRecording);
  stopBtn.addEventListener('click', stopRecording);
  resetBtn.addEventListener('click', resetRecording);

  uploadBtn.addEventListener('click', () => {
    if (!audioBlob) {
      alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö‡πÇ‡∏´‡∏•‡∏î
    progressRose.style.display = "block";
    statusDiv.textContent = "üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á simulate upload ‡∏î‡πâ‡∏ß‡∏¢ timeout
    setTimeout(() => {
      progressRose.style.display = "none";
      statusDiv.textContent = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö!";
      uploadBtn.disabled = true;
    }, 3000);

    // TODO: ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô fetch ‡∏´‡∏£‡∏∑‡∏≠ XMLHttpRequest
  });

  // ‡πÄ‡∏£‡∏¥‡πà‡∏° UI ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  resetUI();
</script>

</body>
</html>
