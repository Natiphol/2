<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
  body {
    font-family: 'Kanit', sans-serif;
    max-width: 600px;
    margin: 3rem auto 4rem;
    padding: 2.5rem 2rem 3rem;
    background: linear-gradient(135deg, #1a1a3d, #0d0d29);
    color: #f7f1e3;
    text-align: center;
    border-radius: 20px;
    box-shadow: 0 15px 40px rgba(255, 215, 0, 0.3);
  }
  h1 {
    font-weight: 700;
    font-size: 2.8rem;
    margin-bottom: 0.25rem;
    color: #ffd700;
    text-shadow: 0 0 8px #ffd700aa;
  }
  select, input[type="text"] {
    width: 48%;
    padding: 0.85rem 1.2rem;
    font-size: 1.2rem;
    border-radius: 12px;
    border: 2.5px solid #ffd700;
    margin: 0.3rem 1% 1.2rem;
    outline-offset: 3px;
    background: #222244;
    color: #fffbe6;
    transition: border-color 0.4s ease;
    box-shadow: 0 0 8px #ffd70044;
  }
  select:focus, input[type="text"]:focus {
    border-color: #ffec72;
    box-shadow: 0 0 14px #ffec72cc;
    background: #2a2a55;
  }
  .buttons {
    margin: 2rem 0 1rem;
  }
  button {
    background: linear-gradient(45deg, #ffd700, #ffb300);
    color: #1a1a3d;
    border: none;
    border-radius: 14px;
    padding: 1rem 2.3rem;
    font-size: 1.2rem;
    margin: 0 0.5rem 1rem;
    cursor: pointer;
    font-weight: 700;
    letter-spacing: 0.05em;
    box-shadow: 0 8px 18px rgba(255, 215, 0, 0.7);
    transition: all 0.3s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background: linear-gradient(45deg, #ffec72, #ffda3b);
    box-shadow: 0 10px 28px rgba(255, 223, 36, 0.9);
    transform: translateY(-2px);
  }
  button:disabled {
    background: #555566;
    color: #aaaabb;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }
  #progress-container {
    width: 100%;
    background: #444466;
    border-radius: 12px;
    overflow: hidden;
    margin: 1rem 0 2rem;
    height: 22px;
    box-shadow: inset 0 0 8px #222244;
    display: none;
  }
  #progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #ffd700, #ffb300);
    transition: width 0.3s ease;
  }
  #msg {
    margin-top: 1.4rem;
    font-weight: 700;
    font-size: 1.2rem;
    min-height: 1.5rem;
    color: #ffdb58;
    user-select: none;
    text-shadow: 0 0 10px #ffdb58cc;
  }
</style>
</head>
<body>
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>

  <select id="group" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)" aria-label="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" pattern="[A-Za-z\s]+" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô" />

  <div class="buttons">
    <button id="start" disabled>‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î (‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô)</button>
    <button id="stop" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="upload" disabled>üì§ ‡∏™‡πà‡∏á</button>
  </div>

  <div id="progress-container"><div id="progress-bar"></div></div>

  <p id="msg"></p>

<script>
const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const uploadBtn = document.getElementById("upload");
const msg = document.getElementById("msg");
const nameInput = document.getElementById("name");
const groupSelect = document.getElementById("group");
const progressContainer = document.getElementById("progress-container");
const progressBar = document.getElementById("progress-bar");

const greetingAudio = new Audio("https://natiphol.github.io/33/Test.mp3");

let mediaRecorder;
let recordedChunks = [];
let audioBlob;

const MAX_RECORD_TIME_MS = 180000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ
const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxy-KeKpfN3asYpuRsozRgDn1WIA-oy2Dn7X1gRGKReqJBKKerUHLZrUyN7e3Ddg0C7/exec";

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö input ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î
function checkInputs() {
  const nameValid = /^[A-Za-z\s]+$/.test(nameInput.value.trim());
  startBtn.disabled = !(nameValid && groupSelect.value);
  uploadBtn.disabled = true;
  stopBtn.disabled = true;
}
nameInput.addEventListener("input", checkInputs);
groupSelect.addEventListener("change", checkInputs);

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î
startBtn.addEventListener("click", () => {
  startBtn.disabled = true;
  msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢...";
  greetingAudio.play();
  greetingAudio.onended = () => {
    startRecording();
  };
});

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
async function startRecording() {
  recordedChunks = [];
  msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á... (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ô‡∏≤‡∏ó‡∏µ)";
  stopBtn.disabled = false;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      audioBlob = new Blob(recordedChunks, { type: "audio/webm" });
      msg.textContent = "‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏î‡∏™‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
      uploadBtn.disabled = false;
      stopBtn.disabled = true;
    };

    mediaRecorder.start();

    // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 3 ‡∏ô‡∏≤‡∏ó‡∏µ
    setTimeout(() => {
      if (mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    }, MAX_RECORD_TIME_MS);

  } catch (err) {
    msg.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ";
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }
}

// ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏°
stopBtn.addEventListener("click", () => {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
  }
});

// ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ Google Drive ‡∏ú‡πà‡∏≤‡∏ô Google Apps Script
uploadBtn.addEventListener("click", async () => {
  if (!audioBlob) {
    alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
    return;
  }
  const name = nameInput.value.trim().replace(/\s+/g, "_");
  const group = groupSelect.value;
  if (!name || !group) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...";

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á FormData ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  const formData = new FormData();
  formData.append("action", "check");
  formData.append("name", `${group}_${name}.webm`);

  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥
  try {
    let response = await fetch(UPLOAD_URL, {
      method: "POST",
      body: formData
    });
    let result = await response.json();
    if (result.exists) {
      if (!confirm("‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        msg.textContent = "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
        progressContainer.style.display = "none";
        return;
      }
    }
  } catch {
    msg.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ";
    progressContainer.style.display = "none";
    return;
  }

  // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á
  const uploadData = new FormData();
  uploadData.append("action", "upload");
  uploadData.append("name", `${group}_${name}.webm`);
  uploadData.append("file", audioBlob);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", UPLOAD_URL, true);

  xhr.upload.onprogress = e => {
    if (e.lengthComputable) {
      const percent = (e.loaded / e.total) * 100;
      progressBar.style.width = percent + "%";
    }
  };

  xhr.onload = () => {
    if (xhr.status === 200) {
      msg.textContent = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞!";
    } else {
      msg.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
    }
    progressContainer.style.display = "none";
    progressBar.style.width = "0%";
    startBtn.disabled = false;
    uploadBtn.disabled = true;
  };

  xhr.onerror = () => {
    msg.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
    progressContainer.style.display = "none";
    progressBar.style.width = "0%";
    startBtn.disabled = false;
    uploadBtn.disabled = true;
  };

  xhr.send(uploadData);
});
</script>

</body>
</html>
