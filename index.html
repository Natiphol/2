<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');

    body {
      font-family: 'Kanit', sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem 1.5rem 3rem;
      background: linear-gradient(135deg, #bbdefb 0%, #e3f2fd 100%);
      color: #0a3d62;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      border-radius: 20px;
      user-select: none;
    }

    h1 {
      font-weight: 700;
      font-size: 2.6rem;
      margin-bottom: 0.3rem;
      color: #0984e3;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }

    #logo {
      width: 120px;
      max-width: 40vw;
      margin: 0 auto 1.2rem;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15));
      border-radius: 14px;
      transition: transform 0.3s ease;
    }
    #logo:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
    }

    p.description {
      font-size: 1.15rem;
      margin-top: 0;
      margin-bottom: 2rem;
      color: #3742fa;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    select, input[type="text"] {
      width: 48%;
      padding: 0.75rem 1rem;
      font-size: 1.15rem;
      border-radius: 14px;
      border: 2.5px solid #74b9ff;
      margin: 0.3rem 1% 1.4rem;
      outline-offset: 2px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    select:focus, input[type="text"]:focus {
      border-color: #0984e3;
      box-shadow: 0 0 10px #74b9ffaa;
    }

    div.buttons {
      margin: 1.7rem 0 0.7rem;
    }

    button {
      background: #0984e3;
      color: white;
      border: none;
      border-radius: 14px;
      padding: 1rem 2.2rem;
      font-size: 1.15rem;
      margin: 0 0.5rem 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.25s ease;
      box-shadow: 0 6px 14px rgb(9 132 227 / 0.45);
      user-select: none;
      min-width: 110px;
    }
    button:hover:not(:disabled) {
      background: #74b9ff;
      box-shadow: 0 8px 18px rgb(116 185 255 / 0.8);
    }
    button:disabled {
      background: #dfe6e9;
      color: #7f8c8d;
      cursor: not-allowed;
      box-shadow: none;
    }

    #visualizer {
      width: 100%;
      height: 90px;
      border-radius: 14px;
      margin: 1.7rem 0 2rem;
      background: #dfe6e9;
      box-shadow: inset 0 0 15px #b2bec3;
    }

    audio {
      width: 100%;
      margin-top: 1rem;
      outline: none;
      border-radius: 14px;
      box-shadow: 0 3px 14px rgb(0 0 0 / 0.18);
    }

    #msg {
      margin-top: 1.4rem;
      font-weight: 700;
      color: #0984e3;
      min-height: 1.4rem;
      user-select: none;
      font-size: 1.1rem;
      letter-spacing: 0.02em;
    }
  </style>
</head>
<body>
  <img id="logo" src="https://i.imgur.com/n0DtfkQ.jpg" alt="‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô ‡πÇ‡∏•‡πÇ‡∏Å‡πâ" />
  <h1>‡∏ù‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</h1>
  <p class="description">‡∏à‡∏∞‡∏Æ‡∏≤ ‡∏à‡∏∞‡∏ã‡∏∂‡πâ‡∏á ‡∏à‡∏∞‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏á‡∏Å‡πá‡∏û‡∏≠ üòÑ‚ù§Ô∏è</p>

  <select id="group">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
    <option value="groom_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_family">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
    <option value="groom_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πà‡∏≤‡∏ß</option>
    <option value="bride_friends">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏≤‡∏ß</option>
  </select>
  <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" />

  <div class="buttons">
    <button id="start" disabled>‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏î</button>
    <button id="stop" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
    <button id="play" disabled>üîä ‡∏ü‡∏±‡∏á</button>
    <button id="retry" disabled>üîÅ ‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà</button>
    <button id="upload" disabled>üì§ ‡∏™‡πà‡∏á</button>
  </div>

  <canvas id="visualizer"></canvas>

  <audio id="audio" controls style="display:none;"></audio>

  <p id="msg"></p>

  <script>
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");
    const playBtn = document.getElementById("play");
    const retryBtn = document.getElementById("retry");
    const uploadBtn = document.getElementById("upload");
    const audioPlayback = document.getElementById("audio");
    const msg = document.getElementById("msg");
    const nameInput = document.getElementById("name");
    const groupSelect = document.getElementById("group");
    const canvas = document.getElementById("visualizer");
    const ctx = canvas.getContext("2d");

    let mediaRecorder;
    let recordedChunks = [];
    let audioBlob;
    let animationId;
    let audioContext, analyser, source;
    let stream;

    const MAX_RECORD_TIME_MS = 180000; // 3 ‡∏ô‡∏≤‡∏ó‡∏µ
    let recordTimeout;

    function resetUI() {
      startBtn.disabled = !(nameInput.value.trim() && groupSelect.value);
      stopBtn.disabled = true;
      playBtn.disabled = !audioBlob;
      retryBtn.disabled = !audioBlob;
      uploadBtn.disabled = !audioBlob;
      audioPlayback.style.display = audioBlob ? "block" : "none";
      msg.textContent = "";
      clearTimeout(recordTimeout);
      cancelAnimationFrame(animationId);
      clearCanvas();
    }

    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#dfe6e9";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawVisualizer() {
      analyser.fftSize = 2048;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);

        ctx.fillStyle = "#dfe6e9";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.lineWidth = 3;
        ctx.strokeStyle = "#0984e3";

        ctx.beginPath();

        const sliceWidth = canvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const v = dataArray[i] / 128.0;
          const y = (v * canvas.height) / 2;

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
          x += sliceWidth;
        }

        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
      }
      draw();
    }

    async function initStream() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        source.connect(analyser);

        // Set canvas size dynamically
        canvas.width = canvas.clientWidth;
        canvas.height = 90;

        return true;
      } catch (e) {
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï");
        console.error("getUserMedia error:", e);
        return false;
      }
    }

    function getSupportedMimeType() {
      if (MediaRecorder.isTypeSupported("audio/mp4")) return "audio/mp4";
      if (MediaRecorder.isTypeSupported("audio/m4a")) return "audio/m4a";
      if (MediaRecorder.isTypeSupported("audio/webm")) return "audio/webm";
      if (MediaRecorder.isTypeSupported("audio/ogg")) return "audio/ogg";
      if (MediaRecorder.isTypeSupported("audio/wav")) return "audio/wav";
      return "";
    }

    async function startRecording() {
      if (!nameInput.value.trim()) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
        return false;
      }
      if (!groupSelect.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°");
        return false;
      }

      if (!stream) {
        const ready = await initStream();
        if (!ready) return false;
      }

      recordedChunks = [];
      const mimeType = getSupportedMimeType();

      if (!mimeType) {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
        return false;
      }

      mediaRecorder = new MediaRecorder(stream, { mimeType });
      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(recordedChunks, { type: mimeType });
        const url = URL.createObjectURL(audioBlob);
        audioPlayback.src = url;
        audioPlayback.style.display = "block";
        resetUI();
      };

      // ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏î (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 5)

      mediaRecorder.start();
      msg.textContent = "üéô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á...";
      drawVisualizer();

      startBtn.disabled = true;
      stopBtn.disabled = false;
      playBtn.disabled = true;
      retryBtn.disabled = true;
      uploadBtn.disabled = true;

      recordTimeout = setTimeout(() => {
        stopRecording();
        msg.textContent = "‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 3 ‡∏ô‡∏≤‡∏ó‡∏µ";
      }, MAX_RECORD_TIME_MS);

      return true;
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      stopBtn.disabled = true;
      startBtn.disabled = !(nameInput.value.trim() && groupSelect.value);
      clearTimeout(recordTimeout);
      cancelAnimationFrame(animationId);
      msg.textContent = "üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á";
    }

    startBtn.onclick = () => startRecording();

    stopBtn.onclick = () => stopRecording();

    playBtn.onclick = () => {
      if (audioPlayback.src) {
        audioPlayback.play();
      }
    };

    retryBtn.onclick = () => {
      // ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≠‡∏ô‡∏≠‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 5)
      audioBlob =
